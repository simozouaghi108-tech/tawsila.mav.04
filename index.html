<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TAWSILA.ma</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800;900&display=swap');
    body { font-family: 'Tajawal', sans-serif; scroll-behavior: smooth; }
    .hero-bg { background: linear-gradient(135deg, #c1272d 0%, #006233 100%); }
    .soft-shadow { box-shadow: 0 12px 30px rgba(0,0,0,.08); }
    .ring-focus:focus { outline: none; box-shadow: 0 0 0 4px rgba(193,39,45,.15); border-color: #c1272d; }
    .pill{ font-size: 11px; padding: 4px 10px; border-radius: 999px; border:1px solid #eee; font-weight: 900; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    #map { height: 240px; border-radius: 1.5rem; overflow: hidden; }
    @media (min-width: 1024px){ #map { height: 320px; } }

    .map-wrap { position: relative; }
    .map-wrap.map-fullscreen{
      position: fixed; inset: 0; z-index: 9999;
      background: rgba(255,255,255,.98);
      padding: 12px;
      display: flex; flex-direction: column; gap: 10px;
    }
    .map-wrap.map-fullscreen #map{ height: calc(100vh - 90px); border-radius: 18px; }
    .map-full-topbar{ display:none; }
    .map-wrap.map-fullscreen .map-full-topbar{
      display:flex; align-items:center; justify-content:space-between; gap: 10px;
      padding: 10px 12px; border: 1px solid #eee; border-radius: 16px; background: #fff;
      box-shadow: 0 10px 25px rgba(0,0,0,.06);
    }
    .map-fab{
      position:absolute; top: 10px; right: 10px; z-index: 500;
      display:flex; gap:8px;
    }
    .fab-btn{
      background:#111; color:#fff; border:none; border-radius: 14px;
      padding: 10px 12px; font-weight: 900; font-size: 12px;
      box-shadow: 0 10px 22px rgba(0,0,0,.15);
      cursor:pointer;
    }
    .fab-btn.secondary{
      background:#fff; color:#111; border:1px solid #eee;
      box-shadow: 0 10px 22px rgba(0,0,0,.08);
    }

    .auto-box{ position: relative; }
    .auto-list{
      position:absolute; top: calc(100% + 6px); right: 0; left: 0;
      background:#fff; border:1px solid #eee; border-radius: 14px;
      box-shadow: 0 18px 30px rgba(0,0,0,.10);
      overflow:hidden; z-index: 999;
      max-height: 260px; overflow-y:auto; display:none;
    }
    .auto-item{ padding: 10px 12px; cursor:pointer; border-bottom:1px solid #f3f3f3; }
    .auto-item:hover{ background:#f8fafc; }
    .auto-item b{ display:block; font-size: 13px; color:#111; }
    .auto-item span{ display:block; font-size: 11px; color:#6b7280; margin-top:2px; }

    .hint{ font-size: 11px; color:#9ca3af; margin-top:6px; }

    .lock-overlay{
      position:absolute; inset:0; background: rgba(255,255,255,.92);
      border-radius: 1.5rem; z-index: 50;
      display:none; padding: 18px; align-items:center; justify-content:center; text-align:center;
      backdrop-filter: blur(6px);
    }
    .lock-overlay.show{ display:flex; }

    .table-wrap{ overflow:auto; border-radius: 16px; border:1px solid #eee; }
    table{ width:100%; border-collapse: collapse; min-width: 980px; }
    th,td{ padding: 10px 12px; border-bottom:1px solid #f2f2f2; text-align: start; font-size: 12px; vertical-align: top; }
    th{ background:#fafafa; position: sticky; top: 0; z-index: 1; }
    .role-card{ box-shadow: 0 20px 50px rgba(0,0,0,.16); }
    .btn{ border-radius: 16px; padding: 10px 12px; font-weight: 900; }

    /* RTL/LTR spacing swap (minimal) */
    html[dir="ltr"] .ml-1{ margin-left:0!important; margin-right:.25rem!important; }
    html[dir="ltr"] .ml-2{ margin-left:0!important; margin-right:.5rem!important; }
    html[dir="ltr"] .ml-3{ margin-left:0!important; margin-right:.75rem!important; }
    html[dir="ltr"] .mr-1{ margin-right:0!important; margin-left:.25rem!important; }
    html[dir="ltr"] .mr-2{ margin-right:0!important; margin-left:.5rem!important; }
    html[dir="ltr"] .mr-3{ margin-right:0!important; margin-left:.75rem!important; }
  </style>
</head>

<body class="bg-gray-50 text-gray-900">

  <!-- ROLE PICK MODAL -->
  <div id="roleModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-[200] p-4 backdrop-blur-sm">
    <div class="bg-white p-7 rounded-[2rem] max-w-md w-full role-card">
      <div class="text-center mb-5">
        <div class="w-16 h-16 rounded-full bg-gray-100 text-gray-900 flex items-center justify-center mx-auto text-2xl mb-3">
          <i class="fas fa-user-check"></i>
        </div>
        <div id="roleTitle" class="text-2xl font-extrabold text-gray-900">Ù…Ø±Ø­Ø¨Ø§ ğŸ‘‹</div>
        <div id="roleSub" class="text-sm text-gray-500 mt-1">Ø§Ø®ØªØ§Ø±: ÙˆØ§Ø´ Ù†ØªØ§ <b>Ø³Ø§Ø¦Ù‚</b> ÙˆÙ„Ø§ <b>Ø²Ø¨ÙˆÙ†</b>ØŸ</div>
      </div>

      <div class="grid grid-cols-1 gap-3">
        <button id="pickCustomer" class="w-full bg-gray-900 text-white py-4 rounded-2xl font-extrabold text-lg hover:opacity-90 transition">
          <i class="fas fa-person-walking ml-2"></i> Ø£Ù†Ø§ Ø²Ø¨ÙˆÙ†
        </button>
        <button id="pickDriver" class="w-full bg-red-600 text-white py-4 rounded-2xl font-extrabold text-lg hover:bg-red-700 transition">
          <i class="fas fa-car-side ml-2"></i> Ø£Ù†Ø§ Ø³Ø§Ø¦Ù‚
        </button>
      </div>

      <div id="roleHint" class="text-[11px] text-gray-400 mt-4 text-center">
        * ØªÙ‚Ø¯Ø± ØªØ¨Ø¯Ù‘Ù„ Ø§Ù„Ø¯ÙˆØ± Ù…Ù† Ø²Ø± "ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ±" ÙØ§Ù„ÙÙˆØªØ±.
      </div>
    </div>
  </div>

  <!-- ADMIN MODAL -->
  <div id="adminModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-[210] p-4 backdrop-blur-sm">
    <div class="bg-white rounded-[2rem] max-w-6xl w-full role-card overflow-hidden">
      <div class="p-5 border-b flex items-center justify-between gap-3">
        <div class="flex items-center gap-3">
          <div class="w-11 h-11 rounded-2xl bg-gray-900 text-white flex items-center justify-center">
            <i class="fas fa-shield-halved"></i>
          </div>
          <div>
            <div id="adminTitle" class="font-extrabold text-lg">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>
            <div id="adminSub" class="text-xs text-gray-500">ÙƒØªØ´ÙˆÙ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ù…Ù† Ø£ÙŠ Ù…ØªØµÙØ­ + ØªÙØ¹ÙŠÙ„ 8 Ø£ÙŠØ§Ù…</div>
          </div>
        </div>
        <button id="adminClose" class="px-4 py-2 rounded-2xl border font-extrabold hover:bg-gray-50">
          Ø¥ØºÙ„Ø§Ù‚ <i class="fas fa-xmark mr-1"></i>
        </button>
      </div>

      <div class="p-5">
        <!-- ALWAYS REQUIRE PASSWORD -->
        <div id="adminLoginBox" class="max-w-md mx-auto bg-gray-50 border rounded-3xl p-5">
          <div id="adminLoginTitle" class="font-extrabold mb-2">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
          <div id="adminLoginSub" class="text-xs text-gray-500 mb-3">Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø¯ÙŠØ§Ù„ Admin</div>
          <input id="adminPass" type="password" class="w-full border-2 border-gray-100 p-3 rounded-2xl ring-focus" placeholder="Password">
          <button id="adminLoginBtn" class="w-full mt-3 bg-gray-900 text-white py-3 rounded-2xl font-extrabold hover:opacity-90">
            Ø¯Ø®ÙˆÙ„
          </button>
          <p id="adminLoginErr" class="hidden mt-2 text-sm font-extrabold text-red-600"></p>
        </div>

        <div id="adminPanel" class="hidden">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
            <div class="flex gap-2 flex-wrap">
              <button data-tab="all" class="adminTab btn border bg-white hover:bg-gray-50">Ø§Ù„ÙƒÙ„</button>
              <button data-tab="pending" class="adminTab btn border bg-white hover:bg-gray-50">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ÙˆØµÙ„</button>
              <button data-tab="active" class="adminTab btn border bg-white hover:bg-gray-50">Ù…ÙØ¹Ù‘Ù„ÙŠÙ†</button>
              <button data-tab="expired" class="adminTab btn border bg-white hover:bg-gray-50">Ù…Ù†ØªÙ‡ÙŠÙŠÙ†</button>
            </div>
            <div class="flex gap-2">
              <button id="adminRefreshBtn" class="btn border bg-white hover:bg-gray-50">
                ØªØ­Ø¯ÙŠØ« <i class="fas fa-rotate mr-1"></i>
              </button>
              <button id="adminLogoutBtn" class="btn border bg-white hover:bg-gray-50">
                Ø®Ø±ÙˆØ¬ <i class="fas fa-right-from-bracket mr-1"></i>
              </button>
            </div>
          </div>

          <div class="grid md:grid-cols-3 gap-3 mb-4">
            <div class="bg-gray-50 border rounded-3xl p-4">
              <div id="kpiTotalLbl" class="text-xs text-gray-500 font-extrabold">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†</div>
              <div id="kpiTotal" class="text-2xl font-extrabold mt-1">â€”</div>
            </div>
            <div class="bg-gray-50 border rounded-3xl p-4">
              <div id="kpiActiveLbl" class="text-xs text-gray-500 font-extrabold">Ù…ÙØ¹Ù‘Ù„ÙŠÙ† Ø§Ù„Ø¢Ù†</div>
              <div id="kpiActive" class="text-2xl font-extrabold mt-1">â€”</div>
            </div>
            <div class="bg-gray-50 border rounded-3xl p-4">
              <div id="kpiPendingLbl" class="text-xs text-gray-500 font-extrabold">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ÙˆØµÙ„</div>
              <div id="kpiPending" class="text-2xl font-extrabold mt-1">â€”</div>
            </div>
          </div>

          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th id="thDriver">Ø§Ù„Ø³Ø§Ø¦Ù‚</th>
                  <th id="thPhone">Ø§Ù„Ù‡Ø§ØªÙ</th>
                  <th id="thCIN">CIN</th>
                  <th id="thCityArea">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©/Ø§Ù„Ø­ÙŠ</th>
                  <th id="thVehicle">Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</th>
                  <th id="thStatus">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                  <th id="thSub">Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</th>
                  <th id="thActions">Ø£ÙˆØ§Ù…Ø±</th>
                </tr>
              </thead>
              <tbody id="adminRows"></tbody>
            </table>
          </div>

          <p id="adminNote" class="text-[11px] text-gray-500 mt-3">
            * Ø²Ø± "ØªÙØ¹ÙŠÙ„ 8 Ø£ÙŠØ§Ù…" ÙƒÙŠØ¯ÙŠØ± <span class="mono">subExpiresAt = Ø§Ù„Ø¢Ù† + 8 Ø£ÙŠØ§Ù…</span> ÙˆÙƒÙŠØ±Ø¬Ø¹ ÙƒÙŠØ¨Ø§Ù† ÙÙƒÙ„ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª.
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- NAV -->
  <nav class="bg-white/90 backdrop-blur shadow-sm sticky top-0 z-50">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center gap-3">
      <div class="flex items-center gap-3">
        <h1 class="text-2xl font-black text-red-600 tracking-tighter select-none">
          TAWSILA<span class="text-green-600">.ma</span>
        </h1>
        <span id="apiPill" class="hidden sm:inline-block text-[11px] px-3 py-1 rounded-full border bg-gray-50 text-gray-600">
          API: â€”
        </span>
      </div>

      <div class="flex items-center gap-2">
        <select id="langSelect" class="px-3 py-2 rounded-full border font-extrabold text-xs bg-white hover:bg-gray-50">
          <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
          <option value="fr">FranÃ§ais</option>
          <option value="en">English</option>
        </select>

        <a id="navInstagram" href="#" target="_blank" class="w-9 h-9 rounded-full border flex items-center justify-center hover:bg-gray-50" title="Instagram">
          <i class="fab fa-instagram"></i>
        </a>
        <a id="navFacebook" href="#" target="_blank" class="w-9 h-9 rounded-full border flex items-center justify-center hover:bg-gray-50" title="Facebook">
          <i class="fab fa-facebook"></i>
        </a>

        <button id="adminBtn" class="px-4 py-2 rounded-full border font-extrabold text-xs hover:bg-gray-50" title="Admin">
          <i class="fas fa-shield-halved ml-1"></i> <span id="adminBtnTxt">Admin</span>
        </button>

        <a href="#register" id="goRegister"
           class="bg-red-600 text-white px-5 py-2 rounded-full font-extrabold text-sm hover:bg-red-700 transition">
          Ø³Ø¬Ù„ Ø³Ø§Ø¦Ù‚
        </a>
      </div>
    </div>
  </nav>

  <!-- HERO -->
  <header class="hero-bg text-white py-12 px-4 text-center">
    <h2 id="heroTitle" class="text-3xl md:text-5xl font-black mb-3">Ù„Ù‚Ù€ÙŠ Ø³Ø§Ø¦Ù‚ Ù‚Ø±ÙŠØ¨ Ù…Ù†Ùƒ ÙØ«ÙˆØ§Ù†ÙŠ ğŸš—ğŸï¸</h2>
    <p id="heroSub" class="text-lg opacity-90 mb-6">ØªÙˆØ§ØµÙ„ Ù…Ø¨Ø§Ø´Ø±Ø© ÙˆØ§ØªØ³Ø§Ø¨ Ø£Ùˆ Ø§ØªØµØ§Ù„ â€” Ø§Ù„Ø£Ø¯Ø§Ø¡ Cash ÙÙ‚Ø·.</p>

    <div class="max-w-4xl mx-auto grid sm:grid-cols-3 gap-3 text-sm">
      <div class="bg-white/10 border border-white/15 rounded-2xl p-4">
        <div id="feat1T" class="font-black mb-1"><i class="fas fa-users ml-2"></i>Ø³Ø§Ø¦Ù‚ÙŠÙ† Ù‚Ø±ÙŠØ¨ÙŠÙ† Ù…Ù†Ùƒ</div>
        <div id="feat1S" class="opacity-90">Ø¨Ø­Ø« Ø¨Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© ÙˆØ§Ù„Ø­ÙŠ</div>
      </div>
      <div class="bg-white/10 border border-white/15 rounded-2xl p-4">
        <div id="feat2T" class="font-black mb-1"><i class="fas fa-shield-halved ml-2"></i>ØªÙØ¹ÙŠÙ„ Ø³Ø±ÙŠØ¹</div>
        <div id="feat2S" class="opacity-90">Ø§Ø´ØªØ±Ø§Ùƒ 8 Ø£ÙŠØ§Ù…</div>
      </div>
      <div class="bg-white/10 border border-white/15 rounded-2xl p-4">
        <div id="feat3T" class="font-black mb-1"><i class="fas fa-map-location-dot ml-2"></i>Ø®Ø±ÙŠØ·Ø©</div>
        <div id="feat3S" class="opacity-90">Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙƒÙŠØ¨Ø§Ù† ØºÙŠØ± Ø¥Ù„Ø§ ÙØ¹Ù‘Ù„Ùˆ Ø§Ù„Ø³Ø§Ø¦Ù‚</div>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="container mx-auto px-4 py-10 grid lg:grid-cols-3 gap-8">

    <!-- REGISTER (Driver) -->
    <section id="registerSection" class="relative lg:col-span-1 bg-white p-6 rounded-3xl soft-shadow border border-gray-100 h-fit">
      <h3 id="regTitle" class="text-xl font-black mb-2 flex items-center gap-2">
        <i class="fas fa-id-card text-red-600"></i> ØªØ³Ø¬ÙŠÙ„ Ø³Ø§Ø¦Ù‚ Ø¬Ø¯ÙŠØ¯
      </h3>

      <div id="formNote" class="hidden mb-4 text-sm p-3 rounded-2xl border"></div>

      <div id="driverLockOverlay" class="lock-overlay">
        <div class="max-w-sm">
          <div class="w-14 h-14 rounded-full bg-red-100 text-red-600 flex items-center justify-center mx-auto text-2xl mb-3">
            <i class="fas fa-lock"></i>
          </div>
          <div id="lockTitle" class="font-black text-gray-800 text-lg mb-2">Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ù†ØªÙ‡ÙŠ</div>
          <div id="lockText" class="text-gray-600 text-sm mb-4">
            Ø®Ø§ØµÙƒ ØªØ´Ø­Ù† <b>300 Ø¯Ø±Ù‡Ù…</b> Ø¨Ø§Ø´ ÙŠØªÙØ¹Ù‘Ù„ Ø§Ù„Ø­Ø³Ø§Ø¨ <b>8 Ø£ÙŠØ§Ù…</b>.
          </div>
          <button id="lockRechargeBtn" class="w-full bg-gray-900 text-white py-3 rounded-xl font-black hover:opacity-90 transition">
            <i class="fab fa-whatsapp ml-1"></i> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙˆØµÙ„ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©
          </button>
        </div>
      </div>

      <div class="space-y-4">
        <div>
          <label id="lblName" class="text-xs font-black text-gray-500">Ø§Ù„Ø¥Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
          <input type="text" id="driverName" class="w-full border-2 border-gray-100 p-3 rounded-xl ring-focus"
                 placeholder="Ù…Ø«Ø§Ù„: Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¹Ù„ÙˆÙŠ" autocomplete="name"/>
          <p id="nameErr" class="hidden mt-1 text-xs text-red-600 font-black"></p>
        </div>

        <div>
          <label id="lblVehicle" class="text-xs font-black text-gray-500">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</label>
          <select id="vehicleType" class="w-full border-2 border-gray-100 p-3 rounded-xl ring-focus">
            <option value="Ø³ÙŠØ§Ø±Ø©" id="optCar">Ø³ÙŠØ§Ø±Ø©</option>
            <option value="Ø¯Ø±Ø§Ø¬Ø©" id="optBike">Ø¯Ø±Ø§Ø¬Ø© Ù†Ø§Ø±ÙŠØ©</option>
          </select>
        </div>

        <div>
          <label id="lblCity" class="text-xs font-black text-gray-500">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label>
          <input id="driverCityInput" list="citiesList"
                 class="w-full border-2 border-gray-100 p-3 rounded-xl ring-focus"
                 placeholder="ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©..." autocomplete="off"/>
          <p id="cityErr" class="hidden mt-1 text-xs text-red-600 font-black"></p>
        </div>

        <div class="auto-box">
          <label id="lblArea" class="text-xs font-black text-gray-500">Ø§Ù„Ø­ÙŠ / Ø§Ù„Ø´Ø§Ø±Ø¹ / Ø§Ù„Ø²Ù‚Ø§Ù‚</label>
          <input id="driverAreaInput" class="w-full border-2 border-gray-100 p-3 rounded-xl ring-focus"
                 placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ù…Ø¹Ø§Ø±ÙŠÙ / Ø´Ø§Ø±Ø¹ Ù…Ø­Ù…Ø¯ Ø§Ù„Ø®Ø§Ù…Ø³..." autocomplete="off"/>
          <div id="driverAreaList" class="auto-list"></div>
          <div id="driverAreaHint" class="hint">* ÙƒØªØ¨ Ø£ÙŠ Ø­ÙŠ/Ø´Ø§Ø±Ø¹/Ø²Ù‚Ø§Ù‚ØŒ ÙˆØºØ§Ø¯ÙŠ ÙŠØ¨Ø§Ù† Ù„ÙŠÙƒ Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª ÙØ§Ù„Ù…ØºØ±Ø¨ ÙƒØ§Ù…Ù„.</div>
          <p id="areaErr" class="hidden mt-1 text-xs text-red-600 font-black"></p>
        </div>

        <div>
          <label id="lblPhone" class="text-xs font-black text-gray-500">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
          <input type="tel" id="driverPhone" class="w-full border-2 border-gray-100 p-3 rounded-xl ring-focus text-left"
                 dir="ltr" inputmode="tel" autocomplete="tel" placeholder="Ù…Ø«Ø§Ù„: 0612345678"/>
          <p id="phoneErr" class="hidden mt-1 text-xs text-red-600 font-black"></p>
          <p id="autoFillHint" class="text-[10px] text-gray-400 mt-1">* Ø¥Ù„Ø§ ÙƒÙ†Øª Ù…Ø³Ø¬Ù‘Ù„ Ù‚Ø¨Ù„ØŒ Ø¯Ø®Ù„ ØºÙŠØ± Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙˆØºØ§Ø¯ÙŠ Ù†Ø¬ÙŠØ¨ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø£ÙˆØªÙˆÙ…Ø§ØªÙŠÙƒ.</p>
        </div>

        <div>
          <label id="lblCIN" class="text-xs font-black text-gray-500">Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ÙˆØ·Ù†ÙŠØ© (CIN)</label>
          <input type="text" id="driverCIN" class="w-full border-2 border-gray-100 p-3 rounded-xl ring-focus text-left uppercase"
                 dir="ltr" autocomplete="off" placeholder="Ù…Ø«Ø§Ù„: AB123456"/>
          <p id="cinPrivacy" class="text-[10px] text-gray-400 mt-1">* CIN Ù…Ø§ ÙƒÙŠØ¨Ø§Ù†Ø´ Ù„Ù„Ø²Ø¨ÙˆÙ†ØŒ ØºÙŠØ± Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©/Ø§Ù„ØªÙØ¹ÙŠÙ„.</p>
          <p id="cinErr" class="hidden mt-1 text-xs text-red-600 font-black"></p>
        </div>

        <div class="bg-gray-50 p-4 rounded-2xl border border-gray-200">
          <div class="flex items-center justify-between gap-3">
            <div>
              <p id="lblLocOpt" class="text-xs font-black text-gray-600">Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</p>
              <p id="driverLocText" class="text-[11px] text-gray-500 mt-1">Ø¨Ø§Ø´ ÙŠØ¨Ø§Ù† Ù„Ù„Ø²Ø¨ÙˆÙ† Ø§Ù„Ù‚Ø±ÙŠØ¨ Ù…Ù†ÙƒØŒ ÙØ¹Ù‘Ù„ Ù…ÙˆÙ‚Ø¹Ùƒ.</p>
            </div>
            <button id="driverLocBtn" class="bg-white border px-3 py-2 rounded-xl text-xs font-black hover:bg-gray-100 transition">
              <i class="fas fa-location-crosshairs ml-1"></i> <span id="useMyLocTxt">Ø§Ø³ØªØ¹Ù…Ø§Ù„ Ù…ÙˆÙ‚Ø¹ÙŠ</span>
            </button>
          </div>
        </div>

        <div class="bg-gray-50 p-4 rounded-2xl border border-dashed border-gray-200">
          <p id="lblPayMethods" class="text-xs text-gray-500 mb-2 font-black">Ø·Ø±Ù‚ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„Ø© Ù„Ø¯ÙŠÙƒ:</p>
          <div class="flex flex-wrap gap-2 text-xs">
            <label class="bg-white px-3 py-1 rounded-full border shadow-sm cursor-pointer select-none">
              <input type="checkbox" class="payMethod ml-1" value="Cash" checked disabled>
              <span id="cashOnlyTxt">Cash ÙÙ‚Ø·</span>
            </label>
          </div>
        </div>

        <button id="registerBtn" class="w-full bg-red-600 text-white py-4 rounded-2xl font-black text-lg hover:shadow-lg transition transform active:scale-95">
          ØªØ³Ø¬ÙŠÙ„ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙˆØµÙ„
        </button>

        <div id="afterRegisterBox" class="hidden mt-3 bg-green-50 border border-green-200 rounded-3xl p-4">
          <div id="afterRegisterMsg" class="text-sm font-black text-green-800">ØªÙ… ØªØ³Ø¬ÙŠÙ„Ùƒ âœ…</div>
          <button id="checkStatusBtn" class="w-full mt-3 bg-gray-900 text-white py-3 rounded-2xl font-black hover:opacity-90 transition">
            Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„Ø©
          </button>
          <p id="statusResult" class="mt-2 text-xs text-gray-600 font-black"></p>
        </div>
      </div>
    </section>

    <!-- CUSTOMER -->
    <section id="customerSection" class="lg:col-span-2">

      <div class="flex items-center justify-between mb-6">
        <h3 id="driversTitle" class="text-2xl font-black flex items-center gap-2">
          <i class="fas fa-road text-gray-300"></i>
          Ø§Ù„Ø³Ø§Ø¦Ù‚ÙˆÙ† (Ø¬Ø¯Ø¯ + Ù‚Ø¯Ø§Ù…Ù‰)
        </h3>
        <span id="syncBadge" class="text-sm bg-green-100 text-green-700 px-3 py-1 rounded-full animate-pulse">Ù…Ø²Ø§Ù…Ù†Ø©</span>
      </div>

      <!-- âœ… CUSTOMER SERVICES (Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ÙˆÙ„): Ø§Ù„Ø±Ø­Ù„Ø© + Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø²Ø¨ÙˆÙ† -->
      <div class="bg-white border border-gray-100 rounded-3xl p-4 soft-shadow mb-4 space-y-4">

        <!-- Trip -->
        <div class="bg-gray-50 border border-gray-100 rounded-3xl p-4">
          <div class="flex items-center justify-between gap-3">
            <div>
              <p id="tripTitle" class="text-xs font-black text-gray-600">Ø·Ù„Ø¨ Ø±Ø­Ù„Ø© (Ù…Ù† â†’ Ø¥Ù„Ù‰)</p>
              <p id="tripNote" class="text-[11px] text-gray-400 mt-1">ÙƒØªØ¨ Ø­ÙŠ/Ø´Ø§Ø±Ø¹/Ø²Ù‚Ø§Ù‚ + Ù…Ø¯ÙŠÙ†Ø©â€¦ ÙˆØºØ§Ø¯ÙŠ ÙŠØ¨Ø§Ù† Ø§Ù‚ØªØ±Ø§Ø­ Ø°ÙƒÙŠ.</p>
            </div>
            <span id="tripStatus" class="text-xs px-3 py-1 rounded-full bg-white border text-gray-500">Ø¬Ø§Ù‡Ø²</span>
          </div>

          <div class="grid md:grid-cols-3 gap-3 mt-3 items-end">
            <div class="auto-box">
              <label id="fromLbl" class="text-xs font-black text-gray-500">Ù…Ù†</label>
              <input id="tripFrom" class="w-full border-2 border-gray-100 p-3 rounded-xl ring-focus" autocomplete="off"
                     placeholder="Ù…Ø«Ø§Ù„: Ø­ÙŠ Ø§Ù„Ù…Ø¹Ø§Ø±ÙŠÙØŒ Ø§Ù„Ø¯Ø§Ø± Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡">
              <div id="tripFromList" class="auto-list"></div>
              <div id="hintFrom" class="hint">Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª: Ø£Ø­ÙŠØ§Ø¡/Ø´ÙˆØ§Ø±Ø¹/Ø£Ø²Ù‚Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ØºØ±Ø¨.</div>
            </div>

            <div class="auto-box">
              <label id="toLbl" class="text-xs font-black text-gray-500">Ø¥Ù„Ù‰</label>
              <input id="tripTo" class="w-full border-2 border-gray-100 p-3 rounded-xl ring-focus" autocomplete="off"
                     placeholder="Ù…Ø«Ø§Ù„: Ø£ÙƒØ¯Ø§Ù„ØŒ Ø§Ù„Ø±Ø¨Ø§Ø·">
              <div id="tripToList" class="auto-list"></div>
              <div id="hintTo" class="hint">Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª: Ø£Ø­ÙŠØ§Ø¡/Ø´ÙˆØ§Ø±Ø¹/Ø£Ø²Ù‚Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ØºØ±Ø¨.</div>
            </div>

            <div class="flex gap-2">
              <button id="calcTripBtn" class="w-full bg-gray-900 text-white py-3 rounded-xl font-black text-sm hover:opacity-90 transition">
                <i class="fas fa-calculator ml-1"></i> <span id="calcTripTxt">Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø­Ù„Ø©</span>
              </button>
              <button id="useMyLocAsFrom" class="px-4 py-3 rounded-xl border font-black text-sm bg-white hover:bg-gray-50 transition" title="Ø§Ø³ØªØ¹Ù…Ù„ Ù…ÙˆÙ‚Ø¹ÙŠ ÙƒÙ†Ù‚Ø·Ø© Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚">
                <i class="fas fa-location-dot"></i>
              </button>
            </div>
          </div>

          <div id="tripResult" class="hidden mt-3 grid md:grid-cols-4 gap-3">
            <div class="p-3 rounded-2xl bg-white border">
              <div id="distanceLbl" class="text-xs text-gray-500 font-black">Ø§Ù„Ù…Ø³Ø§ÙØ©</div>
              <div id="tripKm" class="text-lg font-black text-gray-800">â€”</div>
            </div>
            <div class="p-3 rounded-2xl bg-white border">
              <div id="durationLbl" class="text-xs text-gray-500 font-black">ÙˆÙ‚Øª Ø§Ù„Ø±Ø­Ù„Ø©</div>
              <div id="tripTime" class="text-lg font-black text-gray-800">â€”</div>
            </div>
            <div class="p-3 rounded-2xl bg-white border">
              <div id="priceCarLbl" class="text-xs text-gray-500 font-black">Ø«Ù…Ù† (Ø³ÙŠØ§Ø±Ø©)</div>
              <div id="tripPriceCar" class="text-lg font-black text-gray-800">â€”</div>
            </div>
            <div class="p-3 rounded-2xl bg-white border">
              <div id="priceMotoLbl" class="text-xs text-gray-500 font-black">Ø«Ù…Ù† (Ø¯Ø±Ø§Ø¬Ø©)</div>
              <div id="tripPriceMoto" class="text-lg font-black text-gray-800">â€”</div>
            </div>
          </div>

          <p id="tripErr" class="hidden mt-2 text-sm text-red-600 font-black"></p>
        </div>

        <!-- Customer location -->
        <div class="grid md:grid-cols-3 gap-3 items-start">
          <div class="md:col-span-2">
            <p id="userLocLbl" class="text-xs font-black text-gray-500">Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø²Ø¨ÙˆÙ†</p>
            <p id="userAddress" class="text-sm font-black text-gray-800 mt-1">Ù…Ø§Ø²Ø§Ù„ Ù…Ø§ ØªÙØ¹Ù„Ø´ Ø§Ù„Ù…ÙˆÙ‚Ø¹</p>
            <p id="userLocNote" class="text-[11px] text-gray-400 mt-1">* ÙƒÙŠØ¬ÙŠØ¨ Ù„Ùƒ Ø­ØªÙ‰ Ø§Ù„Ø­ÙŠ/Ø§Ù„Ø´Ø§Ø±Ø¹ Ø¥Ø°Ø§ Ù…ØªØ§Ø­.</p>
          </div>
          <div class="flex gap-2">
            <button id="userLocBtn" class="w-full bg-gray-900 text-white py-3 rounded-xl font-black text-sm hover:opacity-90 transition">
              <i class="fas fa-location-dot ml-1"></i> <span id="enableLocTxt">ØªÙØ¹ÙŠÙ„ Ù…ÙˆÙ‚Ø¹ÙŠ</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Filters -->
      <div class="bg-white border border-gray-100 rounded-3xl p-4 soft-shadow mb-4">
        <div class="grid md:grid-cols-4 gap-3">
          <div>
            <label id="lblFilterCity" class="text-xs font-black text-gray-500">ÙÙ„ØªØ± Ù…Ø¯ÙŠÙ†Ø©</label>
            <input id="filterCity" list="citiesList" class="w-full border-2 border-gray-100 p-3 rounded-xl ring-focus" placeholder="Ù…Ø«Ø§Ù„: Casablanca">
          </div>
          <div>
            <label id="lblFilterArea" class="text-xs font-black text-gray-500">ÙÙ„ØªØ± Ø­ÙŠ</label>
            <input id="filterArea" class="w-full border-2 border-gray-100 p-3 rounded-xl ring-focus" placeholder="Ø§Ù„Ù…Ø¹Ø§Ø±ÙŠÙ...">
          </div>
          <div>
            <label id="lblFilterVeh" class="text-xs font-black text-gray-500">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</label>
            <select id="filterVehicle" class="w-full border-2 border-gray-100 p-3 rounded-xl ring-focus">
              <option value="" id="optAll2">Ø§Ù„ÙƒÙ„</option>
              <option value="Ø³ÙŠØ§Ø±Ø©">Ø³ÙŠØ§Ø±Ø©</option>
              <option value="Ø¯Ø±Ø§Ø¬Ø©">Ø¯Ø±Ø§Ø¬Ø©</option>
            </select>
          </div>
          <div>
            <label id="lblSort" class="text-xs font-black text-gray-500">ØªØ±ØªÙŠØ¨</label>
            <select id="sortBy" class="w-full border-2 border-gray-100 p-3 rounded-xl ring-focus">
              <option value="new" id="sortNew">Ø§Ù„Ø£Ø­Ø¯Ø«</option>
              <option value="old" id="sortOld">Ø§Ù„Ø£Ù‚Ø¯Ù…</option>
              <option value="active" id="sortActive">Ø§Ù„Ù…ÙØ¹Ù‘Ù„ÙŠÙ† Ø£ÙˆÙ„Ø§</option>
            </select>
          </div>
        </div>

        <div class="grid md:grid-cols-4 gap-3 mt-3 items-end">
          <div class="md:col-span-2">
            <label id="lblSearch" class="text-xs font-black text-gray-500">Ø¨Ø­Ø«</label>
            <input id="searchQ" class="w-full border-2 border-gray-100 p-3 rounded-xl ring-focus" placeholder="Ø§Ù„Ø¥Ø³Ù…/Ø§Ù„Ø±Ù‚Ù…/Ø§Ù„Ø­ÙŠ...">
          </div>
          <div>
            <label id="lblRadius" class="text-xs font-black text-gray-500">Ø§Ù„Ù‚Ø±Ø¨ (KM)</label>
            <select id="radiusKm" class="w-full border-2 border-gray-100 p-3 rounded-xl ring-focus">
              <option value="2">2 KM</option>
              <option value="5" selected>5 KM</option>
              <option value="10">10 KM</option>
              <option value="20">20 KM</option>
              <option value="50">50 KM</option>
            </select>
          </div>
          <div class="flex gap-2">
            <button id="nearToggle" class="w-full px-4 py-3 rounded-xl border font-black text-sm bg-gray-100 hover:bg-gray-200 transition" aria-pressed="false">
              Ù‚Ø±ÙŠØ¨ Ù…Ù†ÙŠ
            </button>
          </div>
        </div>

        <div class="flex flex-wrap items-center justify-between gap-2 mt-3">
          <div class="flex gap-2 flex-wrap">
            <span class="pill bg-gray-50 text-gray-700" id="countPill">â€”</span>
            <span class="pill bg-gray-50 text-gray-700" id="updatedPill">â€”</span>
          </div>
          <div class="flex gap-2">
            <button id="refreshBtn" class="px-4 py-2 rounded-2xl border font-black hover:bg-gray-50">
              ØªØ­Ø¯ÙŠØ« <i class="fas fa-rotate mr-1"></i>
            </button>
            <button id="clearCacheBtn" class="px-4 py-2 rounded-2xl border font-black hover:bg-gray-50">
              Ø­Ø°Ù Ø§Ù„Ù…Ø­ÙÙˆØ¸ <i class="fas fa-broom mr-1"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Map -->
      <div class="bg-white border border-gray-100 rounded-3xl p-4 soft-shadow mb-4">
        <div class="flex items-center justify-between gap-2 mb-3">
          <div>
            <div id="mapTitle" class="font-black">Ø§Ù„Ø®Ø±ÙŠØ·Ø©</div>
            <div id="mapSub" class="text-xs text-gray-500">ÙƒÙŠØ¨Ø§Ù† Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¥Ø°Ø§ ÙØ¹Ù‘Ù„Ùˆ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</div>
          </div>
          <div class="flex gap-2">
            <button id="myLocBtn" class="px-4 py-2 rounded-2xl border font-black hover:bg-gray-50">
              Ù…ÙˆÙ‚Ø¹ÙŠ <i class="fas fa-location-crosshairs mr-1"></i>
            </button>
            <button id="mapFullBtn" class="px-4 py-2 rounded-2xl border font-black hover:bg-gray-50">
              ØªÙƒØ¨ÙŠØ± <i class="fas fa-expand mr-1"></i>
            </button>
          </div>
        </div>

        <div id="mapWrap" class="map-wrap">
          <div class="map-full-topbar">
            <div id="mapFsTitle" class="font-black">Ø§Ù„Ø®Ø±ÙŠØ·Ø© (Fullscreen)</div>
            <button id="mapExitBtn" class="px-4 py-2 rounded-2xl border font-black hover:bg-gray-50">
              Ø®Ø±ÙˆØ¬ <i class="fas fa-compress mr-1"></i>
            </button>
          </div>

          <div class="map-fab">
            <button id="mapClearBtn" class="fab-btn secondary">Clear</button>
            <button id="mapExitFabBtn" class="fab-btn hidden">Exit</button>
          </div>

          <div id="map"></div>
        </div>
      </div>

      <!-- Feed -->
      <div id="driversFeed" class="grid md:grid-cols-2 gap-4"></div>
    </section>
  </main>

  <!-- FOOTER -->
  <footer class="border-t bg-white">
    <div class="container mx-auto px-4 py-6 flex flex-col sm:flex-row items-center justify-between gap-3">
      <div id="footerCopy" class="text-sm text-gray-500">Â© TAWSILA.ma</div>
      <div class="flex gap-2">
        <a id="footWa" class="px-4 py-2 rounded-2xl border font-black hover:bg-gray-50" target="_blank">
          WhatsApp <i class="fab fa-whatsapp mr-1"></i>
        </a>
        <button id="switchRoleBtn" class="px-4 py-2 rounded-2xl border font-black hover:bg-gray-50">
          ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ± <i class="fas fa-shuffle mr-1"></i>
        </button>
      </div>
    </div>
  </footer>

  <datalist id="citiesList"></datalist>

  <script>
    /********************
     * âœ… SETTINGS (Ø¨Ø¯Ù‘Ù„ ØºÙŠØ± Ù‡Ø§Ø¯Ùˆ)
     ********************/
    const REMOTE_API_URL = "https://script.google.com/macros/s/AKfycbzxOQEMtzhcsqeLNTTn63-m_tprVpHsTwVdVQAKKfR_fzlRn2sgVpa4_52O4LaLS_Bd/exec"; // Ø±Ø§Ø¨Ø·Ùƒ /exec
    const ADMIN_PASSWORD = "Simo.simo";              // Admin password
    const PLATFORM_WHATSAPP_NUMBER = "212617139424"; // Ø±Ù‚Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Ø¨Ø¯ÙˆÙ† +)

    const SUB_PRICE_DH = 300;
    const SUB_DAYS = 8;                 // âœ… 8 Ø£ÙŠØ§Ù…
    const SUB_MS = SUB_DAYS * 24 * 60 * 60 * 1000;

    // ØªÙ‚Ø¯ÙŠØ± Ø§Ù„Ø«Ù…Ù† (Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ÙˆÙ„)
    const FARES = {
      car:  { base: 8, perKm: 3.2, perMin: 0.0 },
      moto: { base: 6, perKm: 2.4, perMin: 0.0 }
    };

    const AVG_SPEED_KMH_TO_PICKUP = { "Ø³ÙŠØ§Ø±Ø©": 28, "Ø¯Ø±Ø§Ø¬Ø©": 32 };
    function estimateEtaToPickupMin(km, vehicle){
      const speed = AVG_SPEED_KMH_TO_PICKUP[vehicle] || 28;
      return Math.max(1, Math.round((km / speed) * 60 + 2));
    }

    const SOCIAL_LINKS = {
      whatsapp: "https://wa.me/" + PLATFORM_WHATSAPP_NUMBER,
      facebook: "https://www.facebook.com/share/1APLprEUQc/",
      instagram: "https://www.instagram.com/tawsila.ma5?igsh=OWVqbDVtdHMzbHA="
    };

    /********************
     * Local Keys
     ********************/
    const STORAGE_KEY = "tawsila_remote_cache_v1";
    const ROLE_KEY    = "tawsila_role_v1";
    const LANG_KEY    = "tawsila_lang_v1";
    const LAST_DRIVER_PHONE = "tawsila_last_driver_phone_v1";
    const RATINGS_KEY = "tawsila_user_ratings_v1";
    const FILTERS_KEY = "tawsila_filters_v7";
    const TRIP_KEY    = "tawsila_trip_v4";

    /********************
     * Morocco cities
     ********************/
    const MOROCCO_CITIES = [
      "Ø§Ù„Ø¯Ø§Ø± Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡","Ø§Ù„Ø±Ø¨Ø§Ø·","Ø³Ù„Ø§","ØªÙ…Ø§Ø±Ø©","Ø§Ù„Ù‚Ù†ÙŠØ·Ø±Ø©","ÙØ§Ø³","Ù…ÙƒÙ†Ø§Ø³","Ø·Ù†Ø¬Ø©","ØªØ·ÙˆØ§Ù†","Ø§Ù„Ø­Ø³ÙŠÙ…Ø©",
      "ÙˆØ¬Ø¯Ø©","Ø§Ù„Ù†Ø§Ø¸ÙˆØ±","Ø¨Ø±ÙƒØ§Ù†","ØªØ§ÙˆØ±ÙŠØ±Øª","Ø¬Ø±Ø³ÙŠÙ","ØªØ§Ø²Ø©","Ø³Ø·Ø§Øª","Ø¨Ø±Ø´ÙŠØ¯","Ø§Ù„Ù…Ø­Ù…Ø¯ÙŠØ©","Ø¨Ù†Ø³Ù„ÙŠÙ…Ø§Ù†",
      "Ø§Ù„Ø®Ù…ÙŠØ³Ø§Øª","Ø³ÙŠØ¯ÙŠ Ø³Ù„ÙŠÙ…Ø§Ù†","Ø³ÙŠØ¯ÙŠ Ù‚Ø§Ø³Ù…","ÙˆØ²Ø§Ù†","Ø§Ù„Ø¹Ø±Ø§Ø¦Ø´","Ø§Ù„Ù‚ØµØ± Ø§Ù„ÙƒØ¨ÙŠØ±","Ø´ÙØ´Ø§ÙˆÙ†","Ø¢Ø³ÙÙŠ","Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©",
      "Ø§Ù„ØµÙˆÙŠØ±Ø©","Ù…Ø±Ø§ÙƒØ´","Ø¨Ù†ÙŠ Ù…Ù„Ø§Ù„","Ø§Ù„ÙÙ‚ÙŠÙ‡ Ø¨Ù† ØµØ§Ù„Ø­","Ø®Ø±ÙŠØ¨ÙƒØ©","ÙˆØ§Ø¯ÙŠ Ø²Ù…","Ø£Ø²ÙŠÙ„Ø§Ù„","Ø§Ù„Ø±Ø§Ø´ÙŠØ¯ÙŠØ©","ÙˆØ±Ø²Ø§Ø²Ø§Øª",
      "Ø²Ø§ÙƒÙˆØ±Ø©","Ù…ÙŠØ¯Ù„Øª","ØªÙ†ØºÙŠØ±","Ø£ÙƒØ§Ø¯ÙŠØ±","Ø¥Ù†Ø²ÙƒØ§Ù†","Ø¢ÙŠØª Ù…Ù„ÙˆÙ„","Ø§Ù„Ø¯Ø´ÙŠØ±Ø© Ø§Ù„Ø¬Ù‡Ø§Ø¯ÙŠØ©","ØªÙŠØ²Ù†ÙŠØª","ØªØ§Ø±ÙˆØ¯Ø§Ù†Øª",
      "Ø£ÙˆÙ„Ø§Ø¯ ØªØ§ÙŠÙ…Ø©","Ø£ÙŠØª Ø¨Ø§Ù‡Ø§","Ø³ÙŠØ¯ÙŠ Ø¥ÙÙ†ÙŠ","ÙƒÙ„Ù…ÙŠÙ…","Ø·Ø§Ù†Ø·Ø§Ù†","Ø§Ù„Ø³Ù…Ø§Ø±Ø©","Ø§Ù„Ø¹ÙŠÙˆÙ†","Ø§Ù„Ø¯Ø§Ø®Ù„Ø©","Ø¨ÙˆØ¬Ø¯ÙˆØ±",
      "ØµÙØ±Ùˆ","Ø§Ù„Ø­Ø§Ø¬Ø¨","Ø¥ÙØ±Ø§Ù†","Ø®Ù†ÙŠÙØ±Ø©","Ø¬Ø±Ø§Ø¯Ø©","ÙÙƒÙŠÙƒ","Ø§Ù„ÙŠÙˆØ³ÙÙŠØ©","Ù‚Ù„Ø¹Ø© Ø§Ù„Ø³Ø±Ø§ØºÙ†Ø©","Ø³ÙŠØ¯ÙŠ Ø¨Ù†ÙˆØ±",
      "Ø£Ø²Ù…ÙˆØ±","Ø§Ù„Ø²Ù…Ø§Ù…Ø±Ø©","Ø²Ø§ÙŠÙˆ","Ø¯Ø±ÙŠÙˆØ´","Ø¨Ù†ÙŠ Ø£Ù†ØµØ§Ø±","Ù…Ø§Ø±ØªÙŠÙ„","Ø§Ù„ÙÙ†ÙŠØ¯Ù‚","Ø§Ù„Ù…Ø¶ÙŠÙ‚","Ø£ØµÙŠÙ„Ø©"
    ];

    /********************
     * Helpers
     ********************/
    const $ = (id)=>document.getElementById(id);

    function nowMs(){ return Date.now(); }
    function fmtDate(ms){
      if(!ms) return "â€”";
      try{
        const d = new Date(Number(ms));
        const loc = state.lang === "ar" ? "ar-MA" : (state.lang === "fr" ? "fr-MA" : "en-GB");
        return d.toLocaleString(loc);
      }catch(_){ return String(ms); }
    }
    function escapeHtml(s){
      return String(s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
    }
    function normalizePhone(raw){ return String(raw||"").trim().replace(/[^\d]/g, ""); }
    function isValidMoroccanPhone(p){ return /^(06|07)\d{8}$/.test(normalizePhone(p)); }
    function normalizeCIN(raw){ return String(raw||"").trim().toUpperCase().replace(/\s+/g,""); }
    function isValidCIN(cin){ return /^[A-Z]{1,2}\d{3,8}$/.test(normalizeCIN(cin)); }

    function toastNote(kind, text){
      const note = $("formNote");
      note.classList.remove("hidden");
      note.textContent = text;
      note.className = "mb-4 text-sm p-3 rounded-2xl border font-extrabold";
      note.classList.add(kind === "success" ? "bg-green-50 border-green-200 text-green-700" : "bg-red-50 border-red-200 text-red-700");
      setTimeout(()=>{ note.classList.add("hidden"); }, 3500);
    }

    function formatRemaining(ms){
      const totalMin = Math.max(0, Math.floor(ms / 60000));
      const days = Math.floor(totalMin / (60*24));
      const hours = Math.floor((totalMin - days*60*24) / 60);
      const mins = totalMin % 60;
      return { days, hours, mins };
    }

    function isActive(d){
      const exp = Number(d?.subExpiresAt || 0);
      return exp > Date.now();
    }

    function waAdminLink(message){
      const clean = PLATFORM_WHATSAPP_NUMBER.replace(/[^\d]/g,"");
      return `https://wa.me/${clean}?text=${encodeURIComponent(message)}`;
    }

    function distanceKm(lat1, lon1, lat2, lon2){
      const R = 6371;
      const toRad = (d) => d * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return 2 * R * Math.asin(Math.sqrt(a));
    }

    function priceForTrip(distanceKmVal, durationMinVal, vehicleLabel){
      const type = (vehicleLabel === "Ø¯Ø±Ø§Ø¬Ø©") ? "moto" : "car";
      const f = (type === "moto") ? FARES.moto : FARES.car;
      const price = f.base + (distanceKmVal * f.perKm) + (durationMinVal * f.perMin);
      return Math.max(0, Math.round(price));
    }

    /********************
     * i18n (Ù…Ø®ØªØµØ± + Ø¹Ù…Ù„ÙŠ)
     ********************/
    const I18N = {
      ar: {
        adminBtn:"Admin",
        heroTitle:"Ù„Ù‚Ù€ÙŠ Ø³Ø§Ø¦Ù‚ Ù‚Ø±ÙŠØ¨ Ù…Ù†Ùƒ ÙØ«ÙˆØ§Ù†ÙŠ ğŸš—ğŸï¸",
        heroSub:"ØªÙˆØ§ØµÙ„ Ù…Ø¨Ø§Ø´Ø±Ø© ÙˆØ§ØªØ³Ø§Ø¨ Ø£Ùˆ Ø§ØªØµØ§Ù„ â€” Ø§Ù„Ø£Ø¯Ø§Ø¡ Cash ÙÙ‚Ø·.",
        feat1S:"Ø¨Ø­Ø« Ø¨Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© ÙˆØ§Ù„Ø­ÙŠ",
        feat2S:`Ø§Ø´ØªØ±Ø§Ùƒ ${SUB_DAYS} Ø£ÙŠØ§Ù…`,
        feat3S:"Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙƒÙŠØ¨Ø§Ù† ØºÙŠØ± Ø¥Ù„Ø§ ÙØ¹Ù‘Ù„Ùˆ Ø§Ù„Ø³Ø§Ø¦Ù‚",

        roleTitle:"Ù…Ø±Ø­Ø¨Ø§ ğŸ‘‹",
        roleSub:'Ø§Ø®ØªØ§Ø±: ÙˆØ§Ø´ Ù†ØªØ§ <b>Ø³Ø§Ø¦Ù‚</b> ÙˆÙ„Ø§ <b>Ø²Ø¨ÙˆÙ†</b>ØŸ',
        roleHint:'* ØªÙ‚Ø¯Ø± ØªØ¨Ø¯Ù‘Ù„ Ø§Ù„Ø¯ÙˆØ± Ù…Ù† Ø²Ø± "ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ±" ÙØ§Ù„ÙÙˆØªØ±.',
        iAmCustomer:"Ø£Ù†Ø§ Ø²Ø¨ÙˆÙ†",
        iAmDriver:"Ø£Ù†Ø§ Ø³Ø§Ø¦Ù‚",

        regTitle:"ØªØ³Ø¬ÙŠÙ„ Ø³Ø§Ø¦Ù‚ Ø¬Ø¯ÙŠØ¯",
        lblCity:"Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©",
        lblArea:"Ø§Ù„Ø­ÙŠ / Ø§Ù„Ø´Ø§Ø±Ø¹ / Ø§Ù„Ø²Ù‚Ø§Ù‚",
        driverAreaHint:"* ÙƒØªØ¨ Ø£ÙŠ Ø­ÙŠ/Ø´Ø§Ø±Ø¹/Ø²Ù‚Ø§Ù‚ØŒ ÙˆØºØ§Ø¯ÙŠ ÙŠØ¨Ø§Ù† Ù„ÙŠÙƒ Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª ÙØ§Ù„Ù…ØºØ±Ø¨ ÙƒØ§Ù…Ù„.",
        useMyLoc:"Ø§Ø³ØªØ¹Ù…Ø§Ù„ Ù…ÙˆÙ‚Ø¹ÙŠ",
        lockTitle:"Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ù†ØªÙ‡ÙŠ",
        lockText:`Ø®Ø§ØµÙƒ ØªØ´Ø­Ù† <b>${SUB_PRICE_DH} Ø¯Ø±Ù‡Ù…</b> Ø¨Ø§Ø´ ÙŠØªÙØ¹Ù‘Ù„ Ø§Ù„Ø­Ø³Ø§Ø¨ <b>${SUB_DAYS} Ø£ÙŠØ§Ù…</b>.`,
        lockBtn:"Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙˆØµÙ„ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©",

        driversTitle:"Ø§Ù„Ø³Ø§Ø¦Ù‚ÙˆÙ† (Ø¬Ø¯Ø¯ + Ù‚Ø¯Ø§Ù…Ù‰)",
        sync:"Ù…Ø²Ø§Ù…Ù†Ø©",
        apiOk:"API: OK",
        apiErr:"API: ERR",
        apiErrSet:"API: ERR (set URL)",

        tripTitle:"Ø·Ù„Ø¨ Ø±Ø­Ù„Ø© (Ù…Ù† â†’ Ø¥Ù„Ù‰)",
        tripNote:"ÙƒØªØ¨ Ø­ÙŠ/Ø´Ø§Ø±Ø¹/Ø²Ù‚Ø§Ù‚ + Ù…Ø¯ÙŠÙ†Ø©â€¦ ÙˆØºØ§Ø¯ÙŠ ÙŠØ¨Ø§Ù† Ø§Ù‚ØªØ±Ø§Ø­ Ø°ÙƒÙŠ.",
        ready:"Ø¬Ø§Ù‡Ø²",
        calcTrip:"Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø­Ù„Ø©",
        fillFromTo:"Ø¹Ù…Ø± Ù…Ù† ÙˆØ¥Ù„Ù‰.",
        routeFailed:"ØªØ¹Ø°Ø± Ø­Ø³Ø§Ø¨ Ø§Ù„Ø·Ø±ÙŠÙ‚. Ø¬Ø±Ø¨ Ù…ÙƒØ§Ù† Ø¢Ø®Ø±.",
        locating:"Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...",

        userLoc:"Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø²Ø¨ÙˆÙ†",
        locNotEnabled:"Ù…Ø§Ø²Ø§Ù„ Ù…Ø§ ØªÙØ¹Ù„Ø´ Ø§Ù„Ù…ÙˆÙ‚Ø¹",
        locNote:"* ÙƒÙŠØ¬ÙŠØ¨ Ù„Ùƒ Ø­ØªÙ‰ Ø§Ù„Ø­ÙŠ/Ø§Ù„Ø´Ø§Ø±Ø¹ Ø¥Ø°Ø§ Ù…ØªØ§Ø­.",
        enableLoc:"ØªÙØ¹ÙŠÙ„ Ù…ÙˆÙ‚Ø¹ÙŠ",

        nearMe:"Ù‚Ø±ÙŠØ¨ Ù…Ù†ÙŠ",
        noDrivers:"Ù…Ø§ ÙƒØ§ÙŠÙ† Ø­ØªÙ‰ Ø³Ø§Ø¦Ù‚ Ø­Ø§Ù„ÙŠØ§. Ø¬Ø±Ù‘Ø¨ \"ØªØ­Ø¯ÙŠØ«\".",
        countPill:"Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†: {n}",
        updatedPill:"Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: {d}",

        badge_active:"Ù…ÙØ¹Ù‘Ù„",
        badge_pending:"Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ÙˆØµÙ„",
        badge_expired:"Ù…Ù†ØªÙ‡ÙŠ",
        remaining:"Ù…ØªØ¨Ù‚ÙŠ",
        ended:"Ù…Ù†ØªÙ‡ÙŠ",

        call:"Call",
        whatsapp:"WhatsApp",
        showOnMap:"Show on map",
        eta:"ETA",

        statusNeedPhone:"Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø£ÙˆÙ„Ø§Ù‹.",
        statusPending:"Ø§Ù„Ø­Ø§Ù„Ø©: Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø¨ÙˆÙ„ Admin â³",
        statusActive:"Ø§Ù„Ø­Ø§Ù„Ø©: Ù…Ù‚Ø¨ÙˆÙ„ ÙˆÙ…ÙØ¹Ù‘Ù„ âœ…",
        statusExpired:"Ø§Ù„Ø­Ø§Ù„Ø©: Ù…Ù†ØªÙ‡ÙŠ âŒ",
        statusRemaining:"Ù…ØªØ¨Ù‚ÙŠ: {r}",

        adminTitle:"Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©",
        adminSub:`ÙƒØªØ´ÙˆÙ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ù…Ù† Ø£ÙŠ Ù…ØªØµÙØ­ + ØªÙØ¹ÙŠÙ„ ${SUB_DAYS} Ø£ÙŠØ§Ù…`,
        loginTitle:"ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„",
        loginSub:"Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø¯ÙŠØ§Ù„ Admin",
        passWrong:"ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©",
        tab_all:"Ø§Ù„ÙƒÙ„",
        tab_pending:"Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ÙˆØµÙ„",
        tab_active:"Ù…ÙØ¹Ù‘Ù„ÙŠÙ†",
        tab_expired:"Ù…Ù†ØªÙ‡ÙŠÙŠÙ†",
        kpiTotal:"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†",
        kpiActive:"Ù…ÙØ¹Ù‘Ù„ÙŠÙ† Ø§Ù„Ø¢Ù†",
        kpiPending:"Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ÙˆØµÙ„",
        actActivate:`ØªÙØ¹ÙŠÙ„ ${SUB_DAYS} Ø£ÙŠØ§Ù…`,
        actPending:"Pending",
        actExpire:"Ø¥Ù†Ù‡Ø§Ø¡",
        actDelete:"Ø­Ø°Ù",
        confirmDelete:"Ù…ØªØ£ÙƒØ¯ Ø¨Ø§ØºÙŠ ØªØ­Ø°Ù Ù‡Ø§Ø¯ Ø§Ù„Ø³Ø§Ø¦Ù‚ØŸ"
      },
      fr: {
        adminBtn:"Admin",
        heroTitle:"Trouve un chauffeur prÃ¨s de toi en quelques secondes ğŸš—ğŸï¸",
        heroSub:"Contact WhatsApp ou appel â€” Cash only.",
        feat1S:"Recherche par ville/quartier",
        feat2S:`Abonnement ${SUB_DAYS} jours`,
        feat3S:"Position si activÃ©e",

        roleTitle:"Bienvenue ğŸ‘‹",
        roleSub:'Choisis : tu es <b>Chauffeur</b> ou <b>Client</b> ?',
        roleHint:'* Tu peux changer de rÃ´le via le bouton en bas.',
        iAmCustomer:"Je suis client",
        iAmDriver:"Je suis chauffeur",

        regTitle:"Inscription chauffeur",
        lblCity:"Ville",
        lblArea:"Quartier / rue",
        driverAreaHint:"* Tape un lieu au Maroc pour suggestions.",
        useMyLoc:"Utiliser ma position",
        lockTitle:"Abonnement expirÃ©",
        lockText:`Paye <b>${SUB_PRICE_DH} DH</b> pour activer <b>${SUB_DAYS} jours</b>.`,
        lockBtn:"Envoyer le reÃ§u",

        driversTitle:"Chauffeurs",
        sync:"Sync",
        apiOk:"API: OK",
        apiErr:"API: ERR",
        apiErrSet:"API: ERR (set URL)",

        tripTitle:"Trajet (DÃ©part â†’ ArrivÃ©e)",
        tripNote:"Saisis un lieu au Maroc et choisis une suggestion.",
        ready:"PrÃªt",
        calcTrip:"Calculer",
        fillFromTo:"Remplir dÃ©part & arrivÃ©e.",
        routeFailed:"Calcul itinÃ©raire impossible. Essayez un autre lieu.",
        locating:"Localisation...",

        userLoc:"Position client",
        locNotEnabled:"Position non activÃ©e",
        locNote:"* Quartier/rue si disponible.",
        enableLoc:"Activer ma position",

        nearMe:"PrÃ¨s de moi",
        noDrivers:"Aucun chauffeur pour le moment. RafraÃ®chis.",
        countPill:"Chauffeurs: {n}",
        updatedPill:"DerniÃ¨re maj: {d}",

        badge_active:"Actif",
        badge_pending:"En attente",
        badge_expired:"ExpirÃ©",
        remaining:"Restant",
        ended:"ExpirÃ©",

        call:"Appel",
        whatsapp:"WhatsApp",
        showOnMap:"Voir sur carte",
        eta:"ETA",

        statusNeedPhone:"Entre le numÃ©ro dâ€™abord.",
        statusPending:"Statut: En attente â³",
        statusActive:"Statut: Actif âœ…",
        statusExpired:"Statut: ExpirÃ© âŒ",
        statusRemaining:"Restant: {r}",

        adminTitle:"Panneau dâ€™administration",
        adminSub:`Activation ${SUB_DAYS} jours + sync navigateur`,
        loginTitle:"Connexion",
        loginSub:"Entre le mot de passe",
        passWrong:"Mot de passe incorrect",
        tab_all:"Tous",
        tab_pending:"En attente",
        tab_active:"Actifs",
        tab_expired:"ExpirÃ©s",
        kpiTotal:"Total chauffeurs",
        kpiActive:"Actifs",
        kpiPending:"En attente",
        actActivate:`Activer ${SUB_DAYS} jours`,
        actPending:"Pending",
        actExpire:"Expirer",
        actDelete:"Supprimer",
        confirmDelete:"Confirmer la suppression ?"
      },
      en: {
        adminBtn:"Admin",
        heroTitle:"Find a driver near you in seconds ğŸš—ğŸï¸",
        heroSub:"Contact via WhatsApp or call â€” Cash only.",
        feat1S:"Search by city/area",
        feat2S:`${SUB_DAYS}-day subscription`,
        feat3S:"Location shown if enabled",

        roleTitle:"Welcome ğŸ‘‹",
        roleSub:"Choose: are you a <b>Driver</b> or a <b>Customer</b>?",
        roleHint:"* You can switch role from the footer button.",
        iAmCustomer:"Iâ€™m a customer",
        iAmDriver:"Iâ€™m a driver",

        regTitle:"Driver registration",
        lblCity:"City",
        lblArea:"Area / street",
        driverAreaHint:"* Type a place in Morocco for suggestions.",
        useMyLoc:"Use my location",
        lockTitle:"Subscription expired",
        lockText:`Recharge <b>${SUB_PRICE_DH} DH</b> to activate <b>${SUB_DAYS} days</b>.`,
        lockBtn:"Send receipt",

        driversTitle:"Drivers",
        sync:"Sync",
        apiOk:"API: OK",
        apiErr:"API: ERR",
        apiErrSet:"API: ERR (set URL)",

        tripTitle:"Trip (From â†’ To)",
        tripNote:"Type any place in Morocco and pick suggestions.",
        ready:"Ready",
        calcTrip:"Calculate",
        fillFromTo:"Fill From & To.",
        routeFailed:"Route failed. Try another place.",
        locating:"Locating...",

        userLoc:"Customer location",
        locNotEnabled:"Location not enabled",
        locNote:"* Area/street if available.",
        enableLoc:"Enable my location",

        nearMe:"Near me",
        noDrivers:"No drivers for now. Refresh.",
        countPill:"Drivers: {n}",
        updatedPill:"Last update: {d}",

        badge_active:"Active",
        badge_pending:"Pending",
        badge_expired:"Expired",
        remaining:"Remaining",
        ended:"Ended",

        call:"Call",
        whatsapp:"WhatsApp",
        showOnMap:"Show on map",
        eta:"ETA",

        statusNeedPhone:"Enter phone first.",
        statusPending:"Status: Pending â³",
        statusActive:"Status: Active âœ…",
        statusExpired:"Status: Expired âŒ",
        statusRemaining:"Remaining: {r}",

        adminTitle:"Admin Panel",
        adminSub:`Activate ${SUB_DAYS} days + browser sync`,
        loginTitle:"Login",
        loginSub:"Enter admin password",
        passWrong:"Wrong password",
        tab_all:"All",
        tab_pending:"Pending",
        tab_active:"Active",
        tab_expired:"Expired",
        kpiTotal:"Total drivers",
        kpiActive:"Active now",
        kpiPending:"Pending",
        actActivate:`Activate ${SUB_DAYS} days`,
        actPending:"Pending",
        actExpire:"Expire",
        actDelete:"Delete",
        confirmDelete:"Confirm delete?"
      }
    };

    function tr(key){
      const L = I18N[state.lang] || I18N.ar;
      return (L[key] ?? I18N.ar[key] ?? key);
    }
    function trFmt(key, vars){
      let s = tr(key);
      Object.entries(vars||{}).forEach(([k,v]) => s = s.replaceAll("{"+k+"}", String(v)));
      return s;
    }

    /********************
     * State
     ********************/
    const state = {
      lang: localStorage.getItem(LANG_KEY) || "ar",
      role: localStorage.getItem(ROLE_KEY) || "",
      drivers: [],
      updatedAt: 0,
      userPos: null,
      userAddressText: "",
      nearEnabled: false,
      regDriverPos: null,
      tripPick: { from:null, to:null },
      trip: null,
      adminLogged: false,
      adminTab: "all"
    };

    /********************
     * Storage
     ********************/
    function saveCache(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify({ updatedAt: state.updatedAt, drivers: state.drivers }));
    }
    function loadCache(){
      try{
        const raw = JSON.parse(localStorage.getItem(STORAGE_KEY) || "null");
        if(raw && Array.isArray(raw.drivers)) return raw;
      }catch(_){}
      return null;
    }

    function loadRatings(){ try{ return JSON.parse(localStorage.getItem(RATINGS_KEY)||"{}"); }catch(_){ return {}; } }
    function saveRatings(m){ localStorage.setItem(RATINGS_KEY, JSON.stringify(m||{})); }

    function saveTrip(obj){ localStorage.setItem(TRIP_KEY, JSON.stringify(obj)); }
    function loadTrip(){ try{ return JSON.parse(localStorage.getItem(TRIP_KEY)||"null"); }catch(_){ return null; } }

    function saveFilters(obj){ localStorage.setItem(FILTERS_KEY, JSON.stringify(obj||{})); }
    function loadFilters(){ try{ return JSON.parse(localStorage.getItem(FILTERS_KEY)||"{}"); }catch(_){ return {}; } }

    /********************
     * Remote Sync (GET/POST Ù…Ø«Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ÙˆÙ„)
     ********************/
    async function remoteGetState(){
      if(!REMOTE_API_URL) return null;
      try{
        const res = await fetch(REMOTE_API_URL + (REMOTE_API_URL.includes("?") ? "&" : "?") + "t=" + Date.now(), { method:"GET" });
        if(!res.ok) throw new Error("GET failed");
        const data = await res.json();

        // Accept: Array OR {drivers,updatedAt}
        if(Array.isArray(data)) return { updatedAt: 0, drivers: data };
        const drivers = Array.isArray(data.drivers) ? data.drivers : null;
        if(!drivers) return null;
        return { updatedAt: Number(data.updatedAt||0), drivers };
      }catch(_){
        return null;
      }
    }

    async function remoteSetState(drivers){
      if(!REMOTE_API_URL) return false;
      try{
        const payload = { action:"set", updatedAt: Date.now(), drivers };
        const res = await fetch(REMOTE_API_URL, {
          method:"POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });
        if(!res.ok) throw new Error("POST failed");
        state.updatedAt = payload.updatedAt;
        saveCache();
        return true;
      }catch(_){
        return false;
      }
    }

    function setApiPill(ok){
      const pill = $("apiPill");
      pill.classList.remove("hidden");
      if(!REMOTE_API_URL){
        pill.textContent = tr("apiErrSet");
        pill.className = "hidden sm:inline-block text-[11px] px-3 py-1 rounded-full border bg-red-50 text-red-700";
        return;
      }
      if(ok){
        pill.textContent = tr("apiOk");
        pill.className = "hidden sm:inline-block text-[11px] px-3 py-1 rounded-full border bg-green-50 text-green-700";
      }else{
        pill.textContent = tr("apiErr");
        pill.className = "hidden sm:inline-block text-[11px] px-3 py-1 rounded-full border bg-yellow-50 text-yellow-800";
      }
    }

    async function syncFromRemoteFirst(){
      // remote first
      const st = await remoteGetState();
      if(st && Array.isArray(st.drivers)){
        state.drivers = normalizeDrivers(st.drivers);
        state.updatedAt = Number(st.updatedAt||0) || Date.now();
        saveCache();
        setApiPill(true);
        return true;
      }
      // fallback cache
      const cached = loadCache();
      if(cached && Array.isArray(cached.drivers)){
        state.drivers = normalizeDrivers(cached.drivers);
        state.updatedAt = Number(cached.updatedAt||0);
      } else {
        state.drivers = []; // start empty
        state.updatedAt = 0;
      }
      setApiPill(false);
      return false;
    }

    async function remotePoll(){
      const st = await remoteGetState();
      if(!st || !Array.isArray(st.drivers)) { setApiPill(false); return; }
      const incomingAt = Number(st.updatedAt||0);
      if(incomingAt && incomingAt <= (state.updatedAt||0)) { setApiPill(true); return; }
      state.drivers = normalizeDrivers(st.drivers);
      state.updatedAt = incomingAt || Date.now();
      saveCache();
      setApiPill(true);
      renderAll();
    }

    function normalizeDrivers(list){
      return (list||[]).map(d => {
        const dd = { ...d };
        dd.id = dd.id || dd.phone || String(Math.random());
        dd.phone = String(dd.phone||"");
        dd.city = String(dd.city||"");
        dd.area = String(dd.area||"");
        dd.vehicle = String(dd.vehicle||"");
        dd.name = String(dd.name||"");
        dd.cin = String(dd.cin||"");
        dd.createdAt = Number(dd.createdAt || dd.receiptSubmittedAt || Date.now());
        dd.updatedAt = Number(dd.updatedAt || Date.now());
        dd.subExpiresAt = Number(dd.subExpiresAt || 0);
        dd.receiptStatus = dd.receiptStatus || (isActive(dd) ? "active" : "expired");
        if(dd.lat !== undefined) dd.lat = Number(dd.lat);
        if(dd.lon !== undefined) dd.lon = Number(dd.lon);
        dd.ratingAvg = Number(dd.ratingAvg || 0);
        dd.ratingCount = Number(dd.ratingCount || 0);
        dd.pay = Array.isArray(dd.pay) ? dd.pay : (dd.pay ? [String(dd.pay)] : ["Cash"]);
        return dd;
      });
    }

    async function pushDrivers(){
      saveCache();
      const ok = await remoteSetState(state.drivers);
      setApiPill(ok);
      return ok;
    }

    /********************
     * Geo (Nominatim + OSRM) Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ÙˆÙ„
     ********************/
    function geoLang(){
      return state.lang === "fr" ? "fr" : (state.lang === "en" ? "en" : "ar");
    }

    async function nominatimSearch(query, limit=6){
      const url = `https://nominatim.openstreetmap.org/search?format=json&limit=${limit}&countrycodes=ma&addressdetails=1&accept-language=${encodeURIComponent(geoLang())}&q=${encodeURIComponent(query)}`;
      const res = await fetch(url);
      if(!res.ok) throw new Error("Search failed");
      const data = await res.json();
      return Array.isArray(data) ? data : [];
    }

    async function reverseGeocode(lat, lon){
      const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&zoom=18&addressdetails=1&accept-language=${encodeURIComponent(geoLang())}`;
      const res = await fetch(url);
      if(!res.ok) throw new Error("Reverse failed");
      const data = await res.json();
      const addr = data.address || {};
      return { display: data.display_name || "", addr };
    }

    function niceLabelFromAddress(addr){
      const road = addr.road || addr.pedestrian || addr.footway || addr.path;
      const neigh = addr.neighbourhood || addr.suburb || addr.quarter || addr.hamlet || addr.village;
      const city = addr.city || addr.town || addr.municipality || addr.state_district || addr.county;
      const parts = [];
      if(road) parts.push(road);
      if(neigh && (!road || neigh !== road)) parts.push(neigh);
      if(city) parts.push(city);
      return parts.filter(Boolean).join(state.lang === "ar" ? "ØŒ " : ", ");
    }

    async function osrmRoute(from, to){
      const url = `https://router.project-osrm.org/route/v1/driving/${from.lon},${from.lat};${to.lon},${to.lat}?overview=false&alternatives=false&steps=false`;
      const res = await fetch(url);
      if(!res.ok) throw new Error("Routing failed");
      const data = await res.json();
      if(!data.routes || !data.routes[0]) throw new Error("No route found");
      const r = data.routes[0];
      return { distanceKm: r.distance/1000, durationMin: r.duration/60 };
    }

    function debounce(fn, wait=320){
      let t;
      return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); };
    }

    function attachAutocomplete({ inputId, listId, onPick }){
      const input = $(inputId);
      const list = $(listId);
      let lastItems = [];

      const closeList = () => { list.style.display = "none"; list.innerHTML = ""; lastItems = []; };
      const openList = () => { if(list.innerHTML.trim()) list.style.display = "block"; };

      const render = (items) => {
        lastItems = items;
        if(!items.length){ closeList(); return; }
        list.innerHTML = items.map((it, idx) => {
          const addr = it.address || {};
          const title = niceLabelFromAddress(addr) || it.display_name || "";
          const sub = it.display_name || "";
          return `
            <div class="auto-item" data-idx="${idx}">
              <b>${escapeHtml(title)}</b>
              <span>${escapeHtml(sub)}</span>
            </div>
          `;
        }).join("");
        openList();
      };

      const doSearch = debounce(async () => {
        const q = (input.value || "").trim();
        if(q.length < 3){ closeList(); return; }
        try{
          const items = await nominatimSearch(q, 6);
          render(items);
        }catch(_){
          closeList();
        }
      }, 320);

      input.addEventListener("input", doSearch);
      input.addEventListener("focus", () => { if(list.innerHTML.trim()) openList(); });

      document.addEventListener("click", (e) => {
        if(e.target.closest(`#${listId}`)) return;
        if(e.target === input) return;
        closeList();
      });

      list.addEventListener("click", (e) => {
        const item = e.target.closest(".auto-item");
        if(!item) return;
        const idx = Number(item.getAttribute("data-idx"));
        const it = lastItems[idx];
        if(!it) return;

        const addr = it.address || {};
        const label = niceLabelFromAddress(addr) || it.display_name || input.value;

        input.value = label;
        closeList();
        onPick && onPick({ label, lat: Number(it.lat), lon: Number(it.lon), full: it });
      });
    }

    /********************
     * Map
     ********************/
    let map, driversLayer, userMarker, tripFromMarker, tripToMarker;

    function initMap(){
      if(map) return;
      map = L.map('map').setView([33.5731, -7.5898], 11);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);
      driversLayer = L.layerGroup().addTo(map);
    }

    function renderMapMarkers(list){
      if(!map || !driversLayer) return;
      driversLayer.clearLayers();

      if(state.userPos){
        if(!userMarker) userMarker = L.marker([state.userPos.lat, state.userPos.lon]).addTo(map);
        else userMarker.setLatLng([state.userPos.lat, state.userPos.lon]);
        userMarker.bindPopup(`<b>${escapeHtml(tr("userLoc"))}</b><br>${escapeHtml(state.userAddressText||"")}`);
      } else {
        if(userMarker){ map.removeLayer(userMarker); userMarker = null; }
      }

      if(state.tripPick?.from?.lat){
        if(!tripFromMarker) tripFromMarker = L.marker([state.tripPick.from.lat, state.tripPick.from.lon]).addTo(map);
        else tripFromMarker.setLatLng([state.tripPick.from.lat, state.tripPick.from.lon]);
        tripFromMarker.bindPopup(`<b>From</b><br>${escapeHtml(state.tripPick.from.label||"")}`);
      } else {
        if(tripFromMarker){ map.removeLayer(tripFromMarker); tripFromMarker = null; }
      }

      if(state.tripPick?.to?.lat){
        if(!tripToMarker) tripToMarker = L.marker([state.tripPick.to.lat, state.tripPick.to.lon]).addTo(map);
        else tripToMarker.setLatLng([state.tripPick.to.lat, state.tripPick.to.lon]);
        tripToMarker.bindPopup(`<b>To</b><br>${escapeHtml(state.tripPick.to.label||"")}`);
      } else {
        if(tripToMarker){ map.removeLayer(tripToMarker); tripToMarker = null; }
      }

      list.forEach(d => {
        if(typeof d.lat === "number" && typeof d.lon === "number"){
          const wa = `https://wa.me/212${String(d.phone||"").substring(1)}`;
          const status = isActive(d) ? tr("badge_active") : (d.receiptStatus === "pending" ? tr("badge_pending") : tr("badge_expired"));
          const popup = `
            <div style="min-width:220px">
              <b>${escapeHtml(d.name)}</b><br>
              ${escapeHtml(d.city)}${d.area ? " â€¢ " + escapeHtml(d.area) : ""} â€¢ ${escapeHtml(d.vehicle)}<br>
              <div style="margin-top:6px;font-size:12px"><b>${escapeHtml(status)}</b></div>
              <div style="margin-top:8px;display:flex;gap:8px">
                <a style="flex:1;text-align:center;padding:8px;border-radius:10px;background:#111;color:#fff;text-decoration:none"
                   href="tel:${escapeHtml(d.phone)}"><i class="fas fa-phone"></i> ${escapeHtml(tr("call"))}</a>
                <a style="flex:1;text-align:center;padding:8px;border-radius:10px;background:#d1fae5;color:#065f46;text-decoration:none"
                   href="${wa}" target="_blank"><i class="fab fa-whatsapp"></i> ${escapeHtml(tr("whatsapp"))}</a>
              </div>
            </div>
          `;
          L.marker([d.lat, d.lon]).bindPopup(popup).addTo(driversLayer);
        }
      });
    }

    function toggleMapFullscreen(on){
      const wrap = $("mapWrap");
      const willOn = (typeof on === "boolean") ? on : !wrap.classList.contains("map-fullscreen");
      wrap.classList.toggle("map-fullscreen", willOn);
      document.body.style.overflow = willOn ? "hidden" : "";
      $("mapExitFabBtn").classList.toggle("hidden", !willOn);
      setTimeout(() => map && map.invalidateSize && map.invalidateSize(), 250);
    }

    /********************
     * Role
     ********************/
    function applyRole(){
      const isDriver = state.role === "driver";
      const isCustomer = state.role === "customer";

      $("registerSection").classList.toggle("hidden", !isDriver);
      $("customerSection").classList.toggle("hidden", !isCustomer);
      $("goRegister").classList.toggle("hidden", !isDriver);

      if(isCustomer) initMap();
    }

    function openRoleModal(){
      $("roleModal").classList.remove("hidden");
      $("roleModal").classList.add("flex");
      document.body.style.overflow = "hidden";
    }
    function closeRoleModal(){
      $("roleModal").classList.add("hidden");
      $("roleModal").classList.remove("flex");
      document.body.style.overflow = "";
    }

    /********************
     * Language apply
     ********************/
    function applyLang(){
      document.documentElement.lang = state.lang;
      document.documentElement.dir = (state.lang === "ar") ? "rtl" : "ltr";
      $("langSelect").value = state.lang;

      $("adminBtnTxt").textContent = tr("adminBtn");
      $("heroTitle").textContent = tr("heroTitle");
      $("heroSub").textContent = tr("heroSub");
      $("feat1S").textContent = tr("feat1S");
      $("feat2S").textContent = tr("feat2S");
      $("feat3S").textContent = tr("feat3S");

      $("roleTitle").textContent = tr("roleTitle");
      $("roleSub").innerHTML = tr("roleSub");
      $("roleHint").textContent = tr("roleHint");
      $("pickCustomer").innerHTML = `<i class="fas fa-person-walking ml-2"></i> ${tr("iAmCustomer")}`;
      $("pickDriver").innerHTML = `<i class="fas fa-car-side ml-2"></i> ${tr("iAmDriver")}`;

      $("regTitle").innerHTML = `<i class="fas fa-id-card text-red-600"></i> ${tr("regTitle")}`;
      $("lblCity").textContent = tr("lblCity");
      $("lblArea").textContent = tr("lblArea");
      $("driverAreaHint").textContent = tr("driverAreaHint");
      $("useMyLocTxt").textContent = tr("useMyLoc");
      $("lockTitle").textContent = tr("lockTitle");
      $("lockText").innerHTML = tr("lockText");
      $("lockRechargeBtn").innerHTML = `<i class="fab fa-whatsapp ml-1"></i> ${tr("lockBtn")}`;

      $("driversTitle").textContent = tr("driversTitle");
      $("syncBadge").textContent = tr("sync");

      // customer services
      $("tripTitle").textContent = tr("tripTitle");
      $("tripNote").textContent = tr("tripNote");
      $("tripStatus").textContent = tr("ready");
      $("calcTripTxt").textContent = tr("calcTrip");

      $("userLocLbl").textContent = tr("userLoc");
      if(!state.userPos) $("userAddress").textContent = tr("locNotEnabled");
      $("userLocNote").textContent = tr("locNote");
      $("enableLocTxt").textContent = tr("enableLoc");

      $("nearToggle").textContent = tr("nearMe");

      // admin texts
      $("adminTitle").textContent = tr("adminTitle");
      $("adminSub").textContent = tr("adminSub");
      $("adminLoginTitle").textContent = tr("loginTitle");
      $("adminLoginSub").textContent = tr("loginSub");
      if($("adminLoginErr").classList.contains("hidden") === false) $("adminLoginErr").textContent = tr("passWrong");

      // update API pill text
      setApiPill(true);
    }

    /********************
     * UI: Cities datalist + socials
     ********************/
    function buildCities(){
      const dl = $("citiesList");
      dl.innerHTML = MOROCCO_CITIES.map(c => `<option value="${escapeHtml(c)}"></option>`).join("");
    }

    function initSocials(){
      $("navInstagram").href = SOCIAL_LINKS.instagram;
      $("navFacebook").href = SOCIAL_LINKS.facebook;
      $("footWa").href = SOCIAL_LINKS.whatsapp;
    }

    /********************
     * Location
     ********************/
    function requestLocation(){
      return new Promise((resolve, reject) => {
        if(!navigator.geolocation) return reject(new Error("Geolocation not supported"));
        navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy: true, timeout: 12000, maximumAge: 0 });
      });
    }

    async function enableUserLocation(){
      try{
        $("userAddress").textContent = tr("locating");
        const pos = await requestLocation();
        state.userPos = { lat: pos.coords.latitude, lon: pos.coords.longitude };

        try{
          const r = await reverseGeocode(state.userPos.lat, state.userPos.lon);
          const label = niceLabelFromAddress(r.addr) || r.display || tr("locating");
          state.userAddressText = label;
          $("userAddress").textContent = label;
        }catch(_){
          state.userAddressText = "Location set";
          $("userAddress").textContent = state.userAddressText;
        }

        if(map) map.setView([state.userPos.lat, state.userPos.lon], 13);
        renderAll();
      }catch(_){
        state.userPos = null;
        state.userAddressText = "";
        $("userAddress").textContent = tr("locNotEnabled");
        renderAll();
      }
    }

    async function enableDriverLocation(){
      try{
        $("driverLocText").textContent = tr("locating");
        const pos = await requestLocation();
        state.regDriverPos = { lat: pos.coords.latitude, lon: pos.coords.longitude };

        try{
          const r = await reverseGeocode(state.regDriverPos.lat, state.regDriverPos.lon);
          const label = niceLabelFromAddress(r.addr) || r.display || "OK";
          $("driverLocText").textContent = `âœ… ${label}`;
          // auto-fill area if empty
          if(!($("driverAreaInput").value||"").trim()){
            $("driverAreaInput").value = (r.addr.road || r.addr.neighbourhood || r.addr.suburb || label || "").toString().trim();
          }
        }catch(_){
          $("driverLocText").textContent = `âœ… ${state.regDriverPos.lat.toFixed(5)}, ${state.regDriverPos.lon.toFixed(5)}`;
        }
      }catch(_){
        state.regDriverPos = null;
        $("driverLocText").textContent = $("driverLocText").getAttribute("data-default") || "â€”";
      }
    }

    /********************
     * Trip (from Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ÙˆÙ„)
     ********************/
    function setTripStatus(text, kind){
      const el = $("tripStatus");
      el.textContent = text;
      el.className = "text-xs px-3 py-1 rounded-full border";
      if(kind === "ok") el.classList.add("bg-green-50","text-green-700","border-green-200");
      else if(kind === "loading") el.classList.add("bg-blue-50","text-blue-700","border-blue-200");
      else if(kind === "error") el.classList.add("bg-red-50","text-red-700","border-red-200");
      else el.classList.add("bg-white","text-gray-500","border-gray-200");
    }
    function showTripError(msg){ $("tripErr").textContent = msg; $("tripErr").classList.remove("hidden"); }
    function hideTripError(){ $("tripErr").textContent = ""; $("tripErr").classList.add("hidden"); }

    function showTripResult(route){
      $("tripResult").classList.remove("hidden");
      $("tripKm").textContent = `${route.distanceKm.toFixed(1)} KM`;
      $("tripTime").textContent = `${Math.round(route.durationMin)} min`;
      $("tripPriceCar").textContent = `${priceForTrip(route.distanceKm, route.durationMin, "Ø³ÙŠØ§Ø±Ø©")} DH`;
      $("tripPriceMoto").textContent = `${priceForTrip(route.distanceKm, route.durationMin, "Ø¯Ø±Ø§Ø¬Ø©")} DH`;
    }

    async function calcTrip(){
      hideTripError();
      const fromText = ($("tripFrom").value||"").trim();
      const toText = ($("tripTo").value||"").trim();
      if(!fromText || !toText) return showTripError(tr("fillFromTo"));

      try{
        setTripStatus("...", "loading");
        $("calcTripBtn").disabled = true;
        $("calcTripBtn").classList.add("opacity-60");

        const fromCoord = state.tripPick.from?.lat ? { lat: state.tripPick.from.lat, lon: state.tripPick.from.lon } : null;
        const toCoord   = state.tripPick.to?.lat ? { lat: state.tripPick.to.lat, lon: state.tripPick.to.lon } : null;

        const finalFrom = fromCoord || (await (async ()=>{
          const items = await nominatimSearch(fromText, 1);
          if(!items[0]) throw new Error("From not found");
          return { lat:Number(items[0].lat), lon:Number(items[0].lon) };
        })());

        const finalTo = toCoord || (await (async ()=>{
          const items = await nominatimSearch(toText, 1);
          if(!items[0]) throw new Error("To not found");
          return { lat:Number(items[0].lat), lon:Number(items[0].lon) };
        })());

        const route = await osrmRoute(finalFrom, finalTo);

        state.trip = { ...route, fromText, toText, at: Date.now() };
        saveTrip({ trip: state.trip, tripPick: state.tripPick });
        showTripResult(route);
        setTripStatus("OK", "ok");

        // Center map
        const midLat = (finalFrom.lat + finalTo.lat)/2;
        const midLon = (finalFrom.lon + finalTo.lon)/2;
        if(map) map.setView([midLat, midLon], 12);

        renderAll();
      }catch(_){
        setTripStatus("ERR", "error");
        showTripError(tr("routeFailed"));
      }finally{
        $("calcTripBtn").disabled = false;
        $("calcTripBtn").classList.remove("opacity-60");
      }
    }

    /********************
     * Filters
     ********************/
    function getFilters(){
      const raw = loadFilters();
      return {
        city: raw.city || "",
        area: raw.area || "",
        vehicle: raw.vehicle || "",
        sortBy: raw.sortBy || "new",
        q: raw.q || "",
        near: !!raw.near,
        radiusKm: raw.radiusKm || "5"
      };
    }
    function setFilters(p){
      const cur = getFilters();
      const next = { ...cur, ...p };
      saveFilters(next);
      return next;
    }
    function normalizeStr(s){ return String(s||"").trim().toLowerCase(); }

    function computeFilteredDrivers(){
      const f = getFilters();
      const city = normalizeStr(f.city);
      const area = normalizeStr(f.area);
      const vehicle = f.vehicle || "";
      const q = normalizeStr(f.q);
      const near = !!f.near;
      const radiusKm = Number(f.radiusKm || 5);

      // âœ… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: Ø§Ù„Ø²Ø¨ÙˆÙ† ÙŠØ´ÙˆÙ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† (Ø§Ù„Ø¬Ø¯Ø¯ ÙˆØ§Ù„Ù‚Ø¯Ø§Ù…Ù‰) Ø¨Ø¯ÙˆÙ† Ø­Ø¬Ø¨
      let list = state.drivers.slice();

      if(city) list = list.filter(d => normalizeStr(d.city).includes(city));
      if(area) list = list.filter(d => normalizeStr(d.area).includes(area));
      if(vehicle) list = list.filter(d => d.vehicle === vehicle);
      if(q){
        list = list.filter(d => {
          const hay = `${d.name} ${d.phone} ${d.city} ${d.area} ${d.vehicle}`.toLowerCase();
          return hay.includes(q);
        });
      }

      if(near && state.userPos){
        list = list
          .map(d => {
            const km = (typeof d.lat === "number" && typeof d.lon === "number")
              ? distanceKm(state.userPos.lat, state.userPos.lon, d.lat, d.lon)
              : Infinity;
            return { ...d, _nearKm: km };
          })
          .filter(d => d._nearKm <= radiusKm)
          .sort((a,b) => (a._nearKm||0) - (b._nearKm||0));
      }

      // sort
      if(f.sortBy === "old"){
        list.sort((a,b) => (a.createdAt||0) - (b.createdAt||0));
      } else if(f.sortBy === "active"){
        list.sort((a,b) => {
          const aa = isActive(a) ? 0 : 1;
          const bb = isActive(b) ? 0 : 1;
          if(aa !== bb) return aa - bb;
          return (b.createdAt||0) - (a.createdAt||0);
        });
      } else {
        list.sort((a,b) => (b.createdAt||0) - (a.createdAt||0));
      }

      return list;
    }

    /********************
     * Rating (Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ÙˆÙ„)
     ********************/
    function renderStarsStatic(avg){
      avg = Number(avg||0);
      const full = Math.floor(avg);
      const half = (avg - full) >= 0.5;
      let html = "";
      for(let i=1;i<=5;i++){
        if(i <= full) html += `<i class="fas fa-star" style="color:#f59e0b"></i>`;
        else if(i === full+1 && half) html += `<i class="fas fa-star-half-stroke" style="color:#f59e0b"></i>`;
        else html += `<i class="far fa-star" style="color:#d1d5db"></i>`;
      }
      return html;
    }

    function renderStarsInteractive(driverId, currentUserRating){
      let html = `<div class="flex items-center gap-1">`;
      for(let i=1;i<=5;i++){
        const filled = (currentUserRating && i <= currentUserRating);
        html += `
          <span class="star cursor-pointer" data-rate="${i}" data-driver="${escapeHtml(driverId)}" title="${escapeHtml(i)}">
            <i class="${filled ? "fas" : "far"} fa-star" style="color:${filled ? "#f59e0b" : "#d1d5db"}"></i>
          </span>
        `;
      }
      html += `</div>`;
      return html;
    }

    function attachRatingEvents(){
      document.querySelectorAll(".star").forEach(el=>{
        el.onclick = async () => {
          const driverId = el.getAttribute("data-driver");
          const rate = Number(el.getAttribute("data-rate"));
          if(!driverId || !rate) return;

          const map = loadRatings();
          map[driverId] = rate;
          saveRatings(map);

          const idx = state.drivers.findIndex(d => d.id === driverId);
          if(idx >= 0){
            const d = state.drivers[idx];
            const oldCount = Number(d.ratingCount || 0);
            const oldAvg = Number(d.ratingAvg || 0);
            const newAvg = (oldAvg * oldCount + rate) / (oldCount + 1);
            d.ratingAvg = Math.round(newAvg * 10) / 10;
            d.ratingCount = oldCount + 1;
            d.updatedAt = Date.now();
            state.drivers[idx] = d;
            await pushDrivers();
          }
          renderAll();
        };
      });
    }

    /********************
     * Render Drivers (cards + map)
     ********************/
    function statusBadge(d){
      const active = isActive(d);
      const pending = d.receiptStatus === "pending" && !active;
      const expired = !active && !pending;

      const txt = active ? tr("badge_active") : (pending ? tr("badge_pending") : tr("badge_expired"));
      const cls = active ? "bg-green-50 text-green-700 border-green-200" : (pending ? "bg-yellow-50 text-yellow-800 border-yellow-200" : "bg-red-50 text-red-700 border-red-200");
      return `<span class="px-2 py-1 rounded-full border text-[11px] font-black ${cls}">${escapeHtml(txt)}</span>`;
    }

    function renderDriverCard(d){
      const wa = `https://wa.me/212${String(d.phone||"").substring(1)}`;
      const ratingsMap = loadRatings();
      const currentUserRating = ratingsMap[d.id] || 0;

      // subscription line
      let subLine = "";
      if(isActive(d)){
        const rem = formatRemaining(Number(d.subExpiresAt) - Date.now());
        subLine = `<div class="text-[11px] text-gray-500 font-black mt-1">${escapeHtml(tr("remaining"))}: ${rem.days}d ${rem.hours}h ${rem.mins}m</div>`;
      }else{
        subLine = `<div class="text-[11px] text-gray-400 font-black mt-1">${escapeHtml(tr("ended"))}</div>`;
      }

      let distHtml = "";
      if(state.userPos && typeof d.lat === "number" && typeof d.lon === "number"){
        const km = distanceKm(state.userPos.lat, state.userPos.lon, d.lat, d.lon);
        const eta = estimateEtaToPickupMin(km, d.vehicle);
        distHtml = `
          <div class="mt-2 text-[11px] text-gray-500 font-black">
            <i class="fas fa-location-dot ml-1 text-gray-300"></i>
            ${km.toFixed(1)} KM â€¢ ${escapeHtml(tr("eta"))} ${eta} min
          </div>
        `;
      }

      const showMapBtn = (typeof d.lat === "number" && typeof d.lon === "number")
        ? `<button class="w-full text-center bg-white border py-3 rounded-xl font-black text-sm hover:bg-gray-50 showOnMap" data-lat="${d.lat}" data-lon="${d.lon}">
             <i class="fas fa-map-location-dot ml-1"></i> ${escapeHtml(tr("showOnMap"))}
           </button>`
        : `<button class="w-full text-center bg-white border py-3 rounded-xl font-black text-sm opacity-60 cursor-not-allowed" disabled>
             <i class="fas fa-map-location-dot ml-1"></i> ${escapeHtml(tr("showOnMap"))}
           </button>`;

      return `
        <div class="bg-white border border-gray-100 rounded-3xl p-4 soft-shadow">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="text-lg font-black text-gray-900">${escapeHtml(d.name || "â€”")}</div>
              <div class="text-xs text-gray-500 font-black mt-1">
                ${escapeHtml(d.city||"")}${d.area ? " â€¢ " + escapeHtml(d.area) : ""} â€¢ ${escapeHtml(d.vehicle||"")}
              </div>
              <div class="mt-2 flex items-center gap-2">
                <div>${renderStarsStatic(d.ratingAvg||0)}</div>
                <span class="text-[11px] text-gray-500 font-black">(${Number(d.ratingCount||0)})</span>
                ${statusBadge(d)}
              </div>
              ${subLine}
              ${distHtml}
            </div>

            <div class="text-right">
              <div class="text-[10px] text-gray-400 font-black mb-1">Rate</div>
              ${renderStarsInteractive(d.id, currentUserRating)}
            </div>
          </div>

          <div class="mt-4 grid grid-cols-2 gap-2">
            <a class="w-full text-center bg-gray-900 text-white py-3 rounded-xl font-black text-sm hover:opacity-90"
               href="tel:${escapeHtml(d.phone||"")}"><i class="fas fa-phone ml-1"></i> ${escapeHtml(tr("call"))}</a>
            <a class="w-full text-center bg-green-600 text-white py-3 rounded-xl font-black text-sm hover:bg-green-700"
               href="${wa}" target="_blank"><i class="fab fa-whatsapp ml-1"></i> ${escapeHtml(tr("whatsapp"))}</a>
          </div>

          <div class="mt-2">
            ${showMapBtn}
          </div>
        </div>
      `;
    }

    function bindShowOnMapButtons(){
      document.querySelectorAll(".showOnMap").forEach(btn=>{
        btn.onclick = () => {
          const lat = Number(btn.getAttribute("data-lat"));
          const lon = Number(btn.getAttribute("data-lon"));
          if(!map || !isFinite(lat) || !isFinite(lon)) return;
          map.setView([lat, lon], 15);
          toggleMapFullscreen(true);
        };
      });
    }

    /********************
     * Driver lock UI
     ********************/
    function enforceDriverLockUI(){
      const lastPhone = localStorage.getItem(LAST_DRIVER_PHONE) || "";
      const p = normalizePhone(lastPhone);
      if(!p){
        $("driverLockOverlay").classList.remove("show");
        return;
      }
      const d = state.drivers.find(x => normalizePhone(x.phone) === p) || null;
      if(d && !isActive(d)){
        $("driverLockOverlay").classList.add("show");
      }else{
        $("driverLockOverlay").classList.remove("show");
      }
    }

    /********************
     * Register / Auto-fill
     ********************/
    function setFieldErr(id, msg){
      const el = $(id);
      el.textContent = msg;
      el.classList.toggle("hidden", !msg);
    }

    function validateRegister(){
      setFieldErr("nameErr", "");
      setFieldErr("cityErr", "");
      setFieldErr("areaErr", "");
      setFieldErr("phoneErr", "");
      setFieldErr("cinErr", "");

      const name = ($("driverName").value||"").trim();
      const city = ($("driverCityInput").value||"").trim();
      const area = ($("driverAreaInput").value||"").trim();
      const phone = normalizePhone($("driverPhone").value||"");
      const cin = normalizeCIN($("driverCIN").value||"");

      let ok = true;
      if(name.length < 3){ setFieldErr("nameErr", "Ø¯Ø®Ù„ Ø§Ø³Ù… ØµØ­ÙŠØ­"); ok = false; }
      if(!city){ setFieldErr("cityErr", "Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©"); ok = false; }
      if(area.length < 2){ setFieldErr("areaErr", "Ø¯Ø®Ù„ Ø§Ù„Ø­ÙŠ/Ø§Ù„Ø´Ø§Ø±Ø¹"); ok = false; }
      if(!isValidMoroccanPhone(phone)){ setFieldErr("phoneErr", "Ø¯Ø®Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­"); ok = false; }
      if(!isValidCIN(cin)){ setFieldErr("cinErr", "Ø¯Ø®Ù„ CIN ØµØ­ÙŠØ­"); ok = false; }

      if(!ok) return null;
      return { name, city, area, phone, cin };
    }

    function findByPhone(phone){
      const p = normalizePhone(phone);
      return state.drivers.find(d => normalizePhone(d.phone) === p) || null;
    }

    function autoFillByPhone(){
      const phone = normalizePhone($("driverPhone").value||"");
      if(!isValidMoroccanPhone(phone)) return;
      const d = findByPhone(phone);
      if(!d) return;

      $("driverName").value = d.name || "";
      $("driverCityInput").value = d.city || "";
      $("driverAreaInput").value = d.area || "";
      $("vehicleType").value = d.vehicle || "Ø³ÙŠØ§Ø±Ø©";
      $("driverCIN").value = d.cin || "";
      toastNote("success", "Ù„Ù‚ÙŠÙ†Ø§ Ø­Ø³Ø§Ø¨Ùƒ âœ… Ø¬Ø¨Ø¯Ù†Ø§ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø£ÙˆØªÙˆÙ…Ø§ØªÙŠÙƒ.");
    }

    async function registerDriver(){
      const v = validateRegister();
      if(!v) return;

      const vehicle = ($("vehicleType").value||"").trim();
      const lat = state.regDriverPos?.lat;
      const lon = state.regDriverPos?.lon;

      const existing = findByPhone(v.phone);
      let d;

      if(existing){
        d = existing;
        d.name = v.name;
        d.city = v.city;
        d.area = v.area;
        d.vehicle = vehicle;
        d.cin = v.cin;
        d.pay = ["Cash"];
        if(typeof lat === "number" && typeof lon === "number"){ d.lat = lat; d.lon = lon; }
        d.updatedAt = Date.now();
      }else{
        d = {
          id: v.phone,
          name: v.name,
          phone: v.phone,
          city: v.city,
          area: v.area,
          vehicle,
          cin: v.cin,
          pay:["Cash"],
          lat: (typeof lat === "number") ? lat : undefined,
          lon: (typeof lon === "number") ? lon : undefined,
          createdAt: Date.now(),
          updatedAt: Date.now(),
          ratingAvg: 5.0,
          ratingCount: 0,
          subExpiresAt: 0,
          receiptStatus: "pending",
          receiptSubmittedAt: Date.now()
        };
        state.drivers.unshift(d);
      }

      d.receiptStatus = "pending";
      d.receiptSubmittedAt = Date.now();

      localStorage.setItem(LAST_DRIVER_PHONE, v.phone);

      await pushDrivers();

      $("afterRegisterBox").classList.remove("hidden");
      toastNote("success", "ØªØ³Ø¬Ù„ØªÙŠ âœ… Ø¯Ø§Ø¨Ø§ ØºØ§Ø¯ÙŠ ÙŠØªØ­Ù„ WhatsApp Ø¨Ø§Ø´ ØªØ±Ø³Ù„ Ø§Ù„ÙˆØµÙ„ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©.");

      // Open WhatsApp to admin (message contains all driver info + city/area)
      const msg =
`TAWSILA.ma â€” Activation

Name: ${d.name}
Phone: ${d.phone}
City: ${d.city}
Area: ${d.area}
Vehicle: ${d.vehicle}
CIN: ${d.cin}

Subscription: ${SUB_PRICE_DH} DH / ${SUB_DAYS} days

(Please attach receipt photo)`;

      window.open(waAdminLink(msg), "_blank");

      enforceDriverLockUI();
      renderAll();
    }

    /********************
     * Status check
     ********************/
    function checkStatus(){
      const phone = normalizePhone($("driverPhone").value||"");
      if(!phone) { $("statusResult").textContent = tr("statusNeedPhone"); return; }
      const d = findByPhone(phone);
      if(!d) { $("statusResult").textContent = "Not found"; return; }

      if(isActive(d)){
        const rem = formatRemaining(Number(d.subExpiresAt) - Date.now());
        $("statusResult").textContent = tr("statusActive") + " â€” " + trFmt("statusRemaining", { r: `${rem.days}d ${rem.hours}h ${rem.mins}m` });
      }else if(d.receiptStatus === "pending"){
        $("statusResult").textContent = tr("statusPending");
      }else{
        $("statusResult").textContent = tr("statusExpired");
      }
    }

    /********************
     * Admin
     ********************/
    function openAdminModal(){
      $("adminModal").classList.remove("hidden");
      $("adminModal").classList.add("flex");
      document.body.style.overflow = "hidden";
      $("adminLoginBox").classList.remove("hidden");
      $("adminPanel").classList.add("hidden");
      $("adminLoginErr").classList.add("hidden");
      $("adminPass").value = "";
      $("adminPass").focus();
    }

    function closeAdminModal(){
      $("adminModal").classList.add("hidden");
      $("adminModal").classList.remove("flex");
      document.body.style.overflow = "";
    }

    function adminLogin(){
      const pass = $("adminPass").value || "";
      if(pass !== ADMIN_PASSWORD){
        $("adminLoginErr").textContent = tr("passWrong");
        $("adminLoginErr").classList.remove("hidden");
        return;
      }
      state.adminLogged = true;
      $("adminLoginBox").classList.add("hidden");
      $("adminPanel").classList.remove("hidden");
      renderAdmin();
    }

    function adminLogout(){
      state.adminLogged = false;
      $("adminLoginBox").classList.remove("hidden");
      $("adminPanel").classList.add("hidden");
      $("adminPass").value = "";
    }

    function adminKpis(){
      const total = state.drivers.length;
      const active = state.drivers.filter(isActive).length;
      const pending = state.drivers.filter(d => d.receiptStatus === "pending" && !isActive(d)).length;
      $("kpiTotal").textContent = String(total);
      $("kpiActive").textContent = String(active);
      $("kpiPending").textContent = String(pending);
    }

    function adminFilteredList(){
      const tab = state.adminTab;
      let list = state.drivers.slice();
      if(tab === "pending") list = list.filter(d => d.receiptStatus === "pending" && !isActive(d));
      if(tab === "active") list = list.filter(d => isActive(d));
      if(tab === "expired") list = list.filter(d => !isActive(d) && d.receiptStatus !== "pending");
      list.sort((a,b) => (b.createdAt||0) - (a.createdAt||0));
      return list;
    }

    function adminRow(d){
      const active = isActive(d);
      const pending = d.receiptStatus === "pending" && !active;
      const statusTxt = active ? tr("badge_active") : (pending ? tr("badge_pending") : tr("badge_expired"));
      const statusCls = active ? "bg-green-50 text-green-700" : (pending ? "bg-yellow-50 text-yellow-800" : "bg-red-50 text-red-700");

      let subTxt = "â€”";
      if(active){
        const rem = formatRemaining(Number(d.subExpiresAt) - Date.now());
        subTxt = `${tr("remaining")}: ${rem.days}d ${rem.hours}h ${rem.mins}m`;
      }else{
        subTxt = tr("ended");
      }

      const waDriver = `https://wa.me/212${String(d.phone||"").substring(1)}?text=${encodeURIComponent(
`Admin â†’ Driver

Name: ${d.name}
Phone: ${d.phone}
Status: ${statusTxt}
Expires: ${d.subExpiresAt ? fmtDate(d.subExpiresAt) : "-"}

Please send receipt here.`
      )}`;

      return `
        <tr>
          <td class="font-black">${escapeHtml(d.name)}</td>
          <td class="mono">${escapeHtml(d.phone)}</td>
          <td class="mono">${escapeHtml(d.cin||"")}</td>
          <td>${escapeHtml(d.city||"")}<div class="text-[11px] text-gray-400 font-black mt-1">${escapeHtml(d.area||"")}</div></td>
          <td>${escapeHtml(d.vehicle||"")}</td>
          <td><span class="pill ${statusCls}">${escapeHtml(statusTxt)}</span></td>
          <td class="text-xs font-black">${escapeHtml(subTxt)}</td>
          <td>
            <div class="flex flex-wrap gap-2">
              <button class="btn border bg-green-600 text-white hover:bg-green-700 adminAct" data-act="activate" data-id="${escapeHtml(d.id)}">${escapeHtml(tr("actActivate"))}</button>
              <button class="btn border bg-white hover:bg-gray-50 adminAct" data-act="pending" data-id="${escapeHtml(d.id)}">${escapeHtml(tr("actPending"))}</button>
              <button class="btn border bg-red-600 text-white hover:bg-red-700 adminAct" data-act="expire" data-id="${escapeHtml(d.id)}">${escapeHtml(tr("actExpire"))}</button>
              <button class="btn border bg-gray-900 text-white hover:opacity-90 adminAct" data-act="delete" data-id="${escapeHtml(d.id)}">${escapeHtml(tr("actDelete"))}</button>
              <a class="btn border bg-white hover:bg-gray-50" target="_blank" href="${waDriver}">
                <i class="fab fa-whatsapp mr-1"></i> WhatsApp
              </a>
            </div>
          </td>
        </tr>
      `;
    }

    function renderAdmin(){
      if(!state.adminLogged) return;
      adminKpis();
      const list = adminFilteredList();
      $("adminRows").innerHTML = list.map(adminRow).join("") || `
        <tr><td colspan="8" class="text-center text-gray-500 font-black py-6">â€”</td></tr>
      `;

      // activate tab button style
      document.querySelectorAll(".adminTab").forEach(b=>{
        const tab = b.getAttribute("data-tab");
        const on = tab === state.adminTab;
        b.classList.toggle("bg-gray-900", on);
        b.classList.toggle("text-white", on);
        b.classList.toggle("border-gray-900", on);
      });
    }

    async function adminAction(act, id){
      const idx = state.drivers.findIndex(d => d.id === id);
      if(idx < 0) return;

      if(act === "delete"){
        if(!confirm(tr("confirmDelete"))) return;
        state.drivers.splice(idx, 1);
      } else if(act === "activate"){
        state.drivers[idx].subExpiresAt = Date.now() + SUB_MS;
        state.drivers[idx].receiptStatus = "active";
      } else if(act === "pending"){
        state.drivers[idx].subExpiresAt = 0;
        state.drivers[idx].receiptStatus = "pending";
        state.drivers[idx].receiptSubmittedAt = Date.now();
      } else if(act === "expire"){
        state.drivers[idx].subExpiresAt = 0;
        state.drivers[idx].receiptStatus = "expired";
      }
      state.drivers[idx] && (state.drivers[idx].updatedAt = Date.now());

      await pushDrivers();
      renderAdmin();
      enforceDriverLockUI();
      renderAll();
    }

    /********************
     * Render All
     ********************/
    function renderCounts(list){
      $("countPill").textContent = trFmt("countPill", { n: list.length });
      $("updatedPill").textContent = trFmt("updatedPill", { d: state.updatedAt ? fmtDate(state.updatedAt) : "â€”" });
    }

    function renderAll(){
      applyLang();

      // role visibility
      applyRole();

      // customer
      if(state.role === "customer"){
        initMap();
        const list = computeFilteredDrivers();
        renderCounts(list);

        $("driversFeed").innerHTML = list.map(renderDriverCard).join("") || `
          <div class="bg-white border rounded-3xl p-6 text-center text-gray-500 font-black">
            â€” ${escapeHtml(tr("noDrivers"))} â€”
          </div>
        `;
        renderMapMarkers(list);
        attachRatingEvents();
        bindShowOnMapButtons();
      }

      // lock
      enforceDriverLockUI();

      // admin
      if(state.adminLogged) renderAdmin();
    }

    /********************
     * INIT + Events
     ********************/
    function restoreTrip(){
      const saved = loadTrip();
      if(saved){
        if(saved.tripPick) state.tripPick = saved.tripPick;
        if(saved.trip) state.trip = saved.trip;
        if(saved.trip?.fromText) $("tripFrom").value = saved.trip.fromText;
        if(saved.trip?.toText) $("tripTo").value = saved.trip.toText;
        if(saved.trip?.distanceKm) showTripResult(saved.trip);
      }
    }

    function restoreFiltersUI(){
      const f = getFilters();
      $("filterCity").value = f.city || "";
      $("filterArea").value = f.area || "";
      $("filterVehicle").value = f.vehicle || "";
      $("sortBy").value = f.sortBy || "new";
      $("searchQ").value = f.q || "";
      $("radiusKm").value = f.radiusKm || "5";

      state.nearEnabled = !!f.near;
      $("nearToggle").setAttribute("aria-pressed", state.nearEnabled ? "true" : "false");
      $("nearToggle").classList.toggle("bg-green-100", state.nearEnabled);
      $("nearToggle").classList.toggle("border-green-200", state.nearEnabled);
      $("nearToggle").classList.toggle("text-green-800", state.nearEnabled);
    }

    function bindEvents(){
      initSocials();

      $("langSelect").onchange = () => {
        state.lang = $("langSelect").value;
        localStorage.setItem(LANG_KEY, state.lang);
        renderAll();
      };

      $("adminBtn").onclick = openAdminModal;
      $("adminClose").onclick = closeAdminModal;
      $("adminLoginBtn").onclick = adminLogin;
      $("adminLogoutBtn").onclick = adminLogout;
      $("adminRefreshBtn").onclick = async ()=>{ await remotePoll(); renderAdmin(); };

      $("adminRows").addEventListener("click", (e)=>{
        const btn = e.target.closest(".adminAct");
        if(!btn) return;
        const act = btn.getAttribute("data-act");
        const id = btn.getAttribute("data-id");
        if(act && id) adminAction(act, id);
      });

      document.querySelectorAll(".adminTab").forEach(b=>{
        b.onclick = () => {
          state.adminTab = b.getAttribute("data-tab") || "all";
          renderAdmin();
        };
      });

      $("pickCustomer").onclick = () => {
        state.role = "customer";
        localStorage.setItem(ROLE_KEY, state.role);
        closeRoleModal();
        renderAll();
      };
      $("pickDriver").onclick = () => {
        state.role = "driver";
        localStorage.setItem(ROLE_KEY, state.role);
        closeRoleModal();
        renderAll();
      };

      $("switchRoleBtn").onclick = () => {
        // toggle role and show role modal
        localStorage.removeItem(ROLE_KEY);
        state.role = "";
        openRoleModal();
        applyRole();
      };

      // Driver register
      $("driverPhone").addEventListener("blur", autoFillByPhone);
      $("registerBtn").onclick = registerDriver;
      $("checkStatusBtn").onclick = checkStatus;

      $("lockRechargeBtn").onclick = () => {
        const last = localStorage.getItem(LAST_DRIVER_PHONE) || normalizePhone($("driverPhone").value||"");
        const d = last ? findByPhone(last) : null;
        const msg =
`TAWSILA.ma â€” Activation

Name: ${d?.name || ($("driverName").value||"").trim()}
Phone: ${d?.phone || ($("driverPhone").value||"").trim()}
City: ${d?.city || ($("driverCityInput").value||"").trim()}
Area: ${d?.area || ($("driverAreaInput").value||"").trim()}
Vehicle: ${d?.vehicle || ($("vehicleType").value||"").trim()}
CIN: ${d?.cin || ($("driverCIN").value||"").trim()}

Subscription: ${SUB_PRICE_DH} DH / ${SUB_DAYS} days

(Please attach receipt photo)`;
        window.open(waAdminLink(msg), "_blank");
      };

      $("driverLocBtn").onclick = enableDriverLocation;

      // Customer location + map buttons
      $("userLocBtn").onclick = enableUserLocation;
      $("myLocBtn").onclick = enableUserLocation;

      $("mapFullBtn").onclick = () => toggleMapFullscreen(true);
      $("mapExitBtn").onclick = () => toggleMapFullscreen(false);
      $("mapExitFabBtn").onclick = () => toggleMapFullscreen(false);
      $("mapClearBtn").onclick = () => {
        state.tripPick = { from:null, to:null };
        state.trip = null;
        $("tripResult").classList.add("hidden");
        $("tripFrom").value = "";
        $("tripTo").value = "";
        saveTrip({ trip: null, tripPick: state.tripPick });
        renderAll();
      };

      // Trip
      $("calcTripBtn").onclick = calcTrip;
      $("useMyLocAsFrom").onclick = async () => {
        if(!state.userPos){
          await enableUserLocation();
          if(!state.userPos) return;
        }
        try{
          const r = await reverseGeocode(state.userPos.lat, state.userPos.lon);
          const label = niceLabelFromAddress(r.addr) || tr("myLocation") || "My location";
          $("tripFrom").value = label;
          state.tripPick.from = { label, lat: state.userPos.lat, lon: state.userPos.lon };
          saveTrip({ trip: state.trip, tripPick: state.tripPick });
          renderAll();
        }catch(_){
          const label = "My location";
          $("tripFrom").value = label;
          state.tripPick.from = { label, lat: state.userPos.lat, lon: state.userPos.lon };
          saveTrip({ trip: state.trip, tripPick: state.tripPick });
          renderAll();
        }
      };

      // Filters
      $("filterCity").oninput = () => { setFilters({ city: $("filterCity").value }); renderAll(); };
      $("filterArea").oninput = () => { setFilters({ area: $("filterArea").value }); renderAll(); };
      $("filterVehicle").onchange = () => { setFilters({ vehicle: $("filterVehicle").value }); renderAll(); };
      $("sortBy").onchange = () => { setFilters({ sortBy: $("sortBy").value }); renderAll(); };
      $("searchQ").oninput = () => { setFilters({ q: $("searchQ").value }); renderAll(); };
      $("radiusKm").onchange = () => { setFilters({ radiusKm: $("radiusKm").value }); renderAll(); };

      $("nearToggle").onclick = () => {
        const f = getFilters();
        const next = !f.near;
        setFilters({ near: next });
        $("nearToggle").setAttribute("aria-pressed", next ? "true" : "false");
        $("nearToggle").classList.toggle("bg-green-100", next);
        $("nearToggle").classList.toggle("border-green-200", next);
        $("nearToggle").classList.toggle("text-green-800", next);
        renderAll();
      };

      $("refreshBtn").onclick = async () => {
        await remotePoll();
        renderAll();
      };

      $("clearCacheBtn").onclick = () => {
        localStorage.removeItem(STORAGE_KEY);
        localStorage.removeItem(FILTERS_KEY);
        localStorage.removeItem(RATINGS_KEY);
        localStorage.removeItem(TRIP_KEY);
        localStorage.removeItem(LAST_DRIVER_PHONE);
        localStorage.removeItem(ROLE_KEY);
        toastNote("success", "ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø­ÙÙˆØ¸.");
        state.role = "";
        openRoleModal();
      };

      // Autocomplete: driver area + trip from/to (Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ÙˆÙ„)
      attachAutocomplete({ inputId:"driverAreaInput", listId:"driverAreaList", onPick:()=>{} });
      attachAutocomplete({
        inputId:"tripFrom",
        listId:"tripFromList",
        onPick:(p)=>{ state.tripPick.from = p; saveTrip({ trip: state.trip, tripPick: state.tripPick }); renderAll(); }
      });
      attachAutocomplete({
        inputId:"tripTo",
        listId:"tripToList",
        onPick:(p)=>{ state.tripPick.to = p; saveTrip({ trip: state.trip, tripPick: state.tripPick }); renderAll(); }
      });

      // close admin when clicking backdrop
      $("adminModal").addEventListener("click", (e)=>{ if(e.target.id === "adminModal") closeAdminModal(); });
    }

    async function boot(){
      buildCities();
      initSocials();

      // default texts for driver loc
      $("driverLocText").setAttribute("data-default", $("driverLocText").textContent);

      // load from remote/cache
      await syncFromRemoteFirst();

      // restore UI
      restoreTrip();
      restoreFiltersUI();

      // role
      if(!state.role){
        // hide sections until choose
        $("registerSection").classList.add("hidden");
        $("customerSection").classList.add("hidden");
        $("goRegister").classList.add("hidden");
        openRoleModal();
      } else {
        applyRole();
      }

      // set whatsapp footer
      $("footWa").href = SOCIAL_LINKS.whatsapp;

      bindEvents();
      renderAll();

      // poll
      setInterval(remotePoll, 8000);
    }

    boot();
  </script>
</body>
</html>
